---
title: "examples_from_fun_doc"
output: html_document
---

# atrribute_health

```{r}
results <- attribute_health(
erf_shape = "log_linear",
rr_central = 1.369,            # Central relative risk estimate
rr_increment = 10,             # per μg / m^3 increase in PM2.5 exposure
exp_central = 8.85,            # Central exposure estimate in μg / m^3
cutoff_central = 5,            # μg / m^3
bhd_central = 30747            # Baseline health data: lung cancer incidence
)

results$health_main$impact_rounded # Attributable cases
```

```{r}

results <- attribute_health(
  approach_risk = "absolute_risk",
  exp_central = c(57.5, 62.5, 67.5, 72.5, 77.5),
  pop_exp = c(387500, 286000, 191800, 72200, 7700),
  erf_eq_central = "78.9270-3.1162*c+0.0342*c^2"
)

results$health_main$impact_rounded # Attributable cases
```

```{r}
results <- healthiar::attribute_health(
  geo_id_disaggregated = c("Zurich", "Basel", "Geneva", "Ticino", "Valais"),
  geo_id_aggregated = c("Ger","Ger","Fra","Ita","Fra"),
  rr_central = 1.369,
  rr_increment = 10,
  cutoff_central = 5,
  erf_shape = "log_linear",
  exp_central = c(11, 11, 10, 8, 7),
  bhd_central = c(4000, 2500, 3000, 1500, 500)
)

results$health_main$impact_rounded

results$health_detailed$results_raw |> dplyr::select(
  geo_id_disaggregated,
  geo_id_aggregated,
  impact_rounded
)
```

```{r}
# Goal: determine attributable YLD (years lived with disability)
results  <- attribute_health(
  exp_central = 8.85,
  prop_pop_exp = 1,
  cutoff_central = 5,
  bhd_central = 1000,
  rr_central = 1.1, 
  rr_increment = 10, 
  erf_shape = "log_linear",
  duration_central = 100,
  dw_central = 0.5,
  info = "pm2.5_yld"
) 

results$health_main$impact
```

```{r}
# Goal: determine mean attributable health impacts by education level
info <- data.frame(
  education = rep(c("secondary", "bachelor", "master"), each = 5) # education level
)
output_attribute <- attribute_health(
      rr_central = 1.063,
      rr_increment = 10,
      erf_shape = "log_linear",
      cutoff_central =  0,
      exp_central = sample(6:10, 15, replace = TRUE),
      bhd_central = sample(100:500, 15, replace = TRUE),
      geo_id_disaggregated = c(1:nrow(info)), # (random) ID must be entered
      info = info
)
output_stratified <- output_attribute$health_detailed$results_disaggregated |>
  dplyr::group_by(info_1) |> 
  dplyr::summarize(mean_impact = mean(impact)) |> 
  print()
```


# attribute_lifetable

```{r}
# Goal: determine YLL attributable to air pollution exposure during one year using the life table approach
results <- attribute_lifetable(
  health_outcome = "yll",
  approach_exposure = "single_year",
  approach_newborns = "without_newborns",
  exp_central = 8.85,
  prop_pop_exp = 1,
  cutoff_central = 5,
  rr_central =  1.118,
  rr_increment = 10,
  erf_shape = "log_linear",
  age_group = exdat_pop_1$age_group,
  sex = exdat_pop_1$sex,
  bhd_central = exdat_pop_1$deaths,
  population = exdat_pop_1$midyear_population,
  year_of_analysis = 2019,
  min_age = 20
)
results$health_main$impact # Attributable YLL

# Goal: determine attributable premature deaths due to air pollution exposure during one year using the life table approach
results_pm_deaths <- attribute_lifetable(
health_outcome = "deaths",
approach_exposure = "single_year",
exp_central = 8.85,
prop_pop_exp = 1,
cutoff_central = 5,
rr_central =  1.118,
rr_increment = 10,
erf_shape = "log_linear",
age_group = exdat_pop_1$age_group,
sex = exdat_pop_1$sex,
bhd_central = exdat_pop_1$deaths,
population = exdat_pop_1$midyear_population,
year_of_analysis = 2019,
min_age = 20
)
results_pm_deaths$health_main$impact # Attributable premature deaths

# Goal: determine YLL attributable to air pollution exposure (exposure distribution) during one year using the life table approach
results <- attribute_lifetable(
  health_outcome = "yll",
  exp_central = rep(c(8, 9, 10), each = 100*2), # each = length of sex or age_group vector
  prop_pop_exp = rep(c(0.2, 0.3, 0.5), each = 100*2), # each = length of sex or age_group vector
  cutoff_central = 5,
  rr_central = 1.118,
  rr_lower = 1.06,
  rr_upper = 1.179,
  rr_increment = 10,
  erf_shape = "log_linear",
  age_group = rep(
    exdat_pop_1$age_group,
    times = 3), # times = number of exposure categories
  sex = rep(
    exdat_pop_1$sex,
    times = 3), # times = number of exposure categories
  population = rep(
    exdat_pop_1$midyear_population,
    times = 3), # times = number of exposure categories
  bhd_central = rep(
    exdat_pop_1$deaths,
    times = 3), # times = number of exposure categories
  year_of_analysis = 2019,
  info = "PM2.5",
  min_age = 20
)
results$health_main$impact_rounded # Attributable YLL
```
Example with exposure distribution taken from test-attribute_lifetable.R:
|fake_lifetable|exp_dist|exp_time_single_year|newborns_FALSE|min_age_TRUE|max_age_FALSE|time_horizon_FALSE|iteration_FALSE|

# compare

```{r}

# Goal: comparison of two scenarios with delta approach
scenario_A <- attribute_health(
  exp_central = 8.85,   # EXPOSURE 1
  cutoff_central = 5,
  bhd_central = 25000,
  approach_risk = "relative_risk",
  erf_shape = "log_linear",
  rr_central = 1.118,
  rr_increment = 10
)
scenario_B <- attribute_health(
  exp_central = 6,     # EXPOSURE 2
  cutoff_central = 5,
  bhd_central = 25000,
  approach_risk = "relative_risk",
  erf_shape = "log_linear",
  rr_central = 1.118,
  rr_increment = 10
)
results <- compare(
approach_comparison = "delta",
output_attribute_1 = scenario_A,
output_attribute_2 = scenario_B
)
# Inspect the difference, stored in the impact column
results$health_main |>
  dplyr::select(impact, impact_1, impact_2) |> 
  print()

# Goal: comparison of two scenarios with population impact fraction (pif) approach
output_attribute_1 <- attribute_health(
  exp_central = 8.85,   # EXPOSURE 1
  cutoff_central = 5,
  bhd_central = 25000,
  approach_risk = "relative_risk",
  erf_shape = "log_linear",
  rr_central = 1.118, rr_lower = 1.060, rr_upper = 1.179,
  rr_increment = 10
)
output_attribute_2 <- attribute_health(
  exp_central = 6,      # EXPOSURE 2
  cutoff_central = 5,
  bhd_central = 25000,
  approach_risk = "relative_risk",
  erf_shape = "log_linear",
  rr_central = 1.118, rr_lower = 1.060, rr_upper = 1.179,
  rr_increment = 10
)
results <- compare(
  output_attribute_1 = output_attribute_1,
  output_attribute_2 = output_attribute_2,
  approach_comparison = "pif"
)
# Inspect the difference, stored in the impact column
results$health_main$impact 
```

# get_pif

```{r}
# Goal: calculate the population impact fraction (PIF)
results <- get_pif(
  rr_at_exp_1 = 1.043879,
  rr_at_exp_2 = 1.011217,
  prop_pop_exp_1 = 1,
  prop_pop_exp_2 = 1
)
print(results)
```

# summarize_uncertainty

```{r}
attribute_health_output <- attribute_health(
  erf_shape = "log_linear",
  rr_central = 1.369, 
  rr_lower = 1.124, 
  rr_upper = 1.664,
  rr_increment = 10, 
  exp_central = 8.85, 
  exp_lower = 8, 
  exp_upper = 10,
  cutoff_central = 5,
  bhd_central = 30747, 
  bhd_lower = 28000, 
  bhd_upper = 32000
) 

## Then run Monte Carlo simulation
results <- summarize_uncertainty(
  output_attribute = attribute_health_output,
  n_sim = 100
)

results$uncertainty_main$impact
```

# attribute_mod

```{r}

scenario_A <- attribute_health(
  exp_central = 8.85,   # EXPOSURE 1
  cutoff_central = 5, 
  bhd_central = 25000,
  approach_risk = "relative_risk",
  erf_shape = "log_linear",
  rr_central = 1.118,
  rr_increment = 10
)

scenario_A$health_main$impact # Attributable impact in scenario A

## Modify scenario (adjust exposure value)
scenario_B <- attribute_mod(
  output_attribute_1 = scenario_A, 
  exp_central = 6
)

scenario_B$health_main$impact # Attributable impact in scenario B
```

# daly

```{r}
# Goal: obtain DALY (disability-adjusted life years) from two existing \code{attribute_...} outputs
# Step 1: Create YLL (years of life lost) assessment
results_yll <- attribute_lifetable(
  health_outcome = "yll",
  approach_exposure = "single_year",
  approach_newborns = "without_newborns",
  exp_central = 8.85,
  prop_pop_exp = 1,
  cutoff_central = 5,
  rr_central =  1.118,
  rr_increment = 10,
  erf_shape = "log_linear",
  age_group = exdat_pop_1$age_group,
  sex = exdat_pop_1$sex,
  bhd_central = exdat_pop_1$deaths,
  population = exdat_pop_1$midyear_population,
  year_of_analysis = 2019,
  min_age = 20
)
# Step 2: Create YLD (years lived with disability) assessment
results_yld  <- attribute_health(
  exp_central = 8.85,
  prop_pop_exp = 1,
  cutoff_central = 5,
  bhd_central = 1000,
  rr_central = 1.1, 
  rr_increment = 10, 
  erf_shape = "log_linear",
  duration_central = 100,
  dw_central = 0.5,
  info = "pm2.5_yld"
)
# Step 3: obtain DALY
results <- daly(
  output_attribute_yll = results_yll,
  output_attribute_yld = results_yld
)
# Attributable impact in DALY
results$health_main |> 
  dplyr::select(impact, impact_yll, impact_yld)
```

# monetize

```{r}
output_attribute <- attribute_health(
  erf_shape = "log_linear",
  rr_central = exdat_pm_copd$relative_risk, 
  rr_increment = 10, 
  exp_central = exdat_pm_copd$mean_concentration,
  cutoff_central = exdat_pm_copd$cut_off_value,
  bhd_central = exdat_pm_copd$incidence
)

results <- 
  monetize(
    output_attribute = output_attribute,
    discount_shape = "exponential",
    discount_rate = 0.03,
    discount_years = 5,
    valuation = 50000 # E.g. EURO
  )

results$monetization_main |> 
  dplyr::select(impact, monetized_impact)
```

# multiexpose

```{r}
# Goal: determine aggregated health impacts from multiple exposures
# Step 1: create assessment with exposure 1
output_attribute_1 <- attribute_health(
  erf_shape = "log_linear",
  rr_central = 1.369, 
  rr_increment = 10,
  exp_central = 8.85,
  cutoff_central = 5,
  bhd_central = 30747
)
output_attribute_1$health_main$impact
# Step 2: create assessment with exposure 2
output_attribute_2 <- attribute_mod(
  output_attribute_1 = output_attribute_1,
  exp_central = 10.9,
  rr_central = 1.031
)
output_attribute_2$health_main$impact
# Step 3: aggregate impacts of the two assessments
results <- multiexpose(
  output_attribute_1 = output_attribute_1,
  output_attribute_2 = output_attribute_2,
  exposure_name_1 = "pm2.5",
  exposure_name_2 = "no2",
  approach = "multiplicative"
)
results$health_main$impact
```

# socialize

```{r}

exdat_socialize

results_below_40 <-
    healthiar::attribute_health(
      exp_central = exdat_socialize$PM25_MEAN,
      cutoff_central = 0,
      rr_central = 1.08, # The data set contains the RR for the exposure but not per increment. Calculable as e.g. exp(log(1.038017)/(4.848199)*10)
      erf_shape = "log_linear",
      rr_increment = 10,
      bhd_central = exdat_socialize$MORTALITY_TOTAL,
      population = exdat_socialize$POPULATION,
      geo_id_disaggregated = exdat_socialize$CS01012020)

results_40_plus <-
    healthiar::attribute_health(
      exp_central = exdat_socialize$PM25_MEAN-0.1,
      cutoff_central = 0,
      rr_central = 1.08, # The data set contains the RR for the exposure but not per increment. Calculable as e.g. exp(log(1.038017)/(4.848199)*10)
      erf_shape = "log_linear",
      rr_increment = 10,
      bhd_central = ifelse(exdat_socialize$MORTALITY_TOTAL-10<0, 0, exdat_socialize$MORTALITY_TOTAL-10),
      population = ifelse(exdat_socialize$POPULATION-10<0, 0, exdat_socialize$POPULATION-10),
      geo_id_disaggregated = exdat_socialize$CS01012020)
  
results <- socialize(
        age_group = c("below_40", "40_plus"),
        ref_prop_pop = c(0.5, 0.5),
        listed_output_attribute = list(results_below_40, results_40_plus),
        geo_id_disaggregated = data$CS01012020,
        social_indicator = data$score,
        n_quantile = 10,
        increasing_deprivation = TRUE)

results$social_main |> 
  dplyr::filter(difference_type == "relative") |> 
  dplyr::filter(difference_compared_with == "overall") |> 
  dplyr::select(first, last, difference_type, difference_value, comment)
```

# discount

```{r}

results <- discount(
        impact = 2E4,
        discount_shape = "exponential",
        discount_rate = 0.03,
        discount_years = 20)

results$monetization_main$monetized_impact
```

# cba

```{r}

output_attribute <- attribute_health(
  erf_shape = "log_linear", 
  rr_central = 1.369, 
  rr_increment = 10,  
  exp_central = 8.85, 
  cutoff_central = 5, 
  bhd_central = 30747 
) 

results <- cba(
  output_attribute = output_attribute,
  valuation = 50000,
  cost = 100000000,
  discount_shape = "exponential",
  discount_rate_benefit = 0.03,
  discount_rate_cost = 0.03,
  discount_years_benefit = 5,
  discount_years_cost = 5
)

results$cba_main |>  
  dplyr::select(benefit, cost, net_benefit)
```

get_mdi

```{r}

results <- prepare_mdi(
        geo_id_disaggregated = exdat_prepare_mdi$id,
        edu = exdat_prepare_mdi$edu,
        unemployed = exdat_prepare_mdi$unemployed,
        single_parent = exdat_prepare_mdi$single_parent,
        pop_change = exdat_prepare_mdi$pop_change,
        no_heating = exdat_prepare_mdi$no_heating,
        n_quantile = 10)

results |> 
  dplyr::select(geo_id_disaggregated, MDI, MDI_index) |> 
  dplyr::slice(1:15)
```

# standardize

```{r}
# Goal: age-standardize two age group-specific impacts
output_attribute <- attribute_health(
      rr_central = 1.063,
      rr_increment = 10,
      erf_shape = "log_linear",
      cutoff_central =  0,
      age_group = c("below_40", "above_40"),
      exp_central = c(8.1, 10.9),
      bhd_central = c(1000, 4000),
      population = c(100000, 500000)
)
results <- standardize(
  output_attribute = output_attribute,
  age_group = c("below_40", "above_40"),
  ref_prop_pop = c(0.5, 0.5)
)
results$health_detailed$impact_per_100k_inhab # age group-specific impact rate
results$health_main$impact_per_100k_inhab # age-standardized impact rate 
```

# get_risk

```{r}
# Goal: scale relative risk to observed exposure level
get_risk(
  rr = 1.05, 
  rr_increment = 10,
  erf_shape = "linear",
  exp = 10, 
  cutoff = 5 
)
```

# prepare_lifetable

```{r}
# Goal: Convert 5-year population and death data into single year lifetable
results <- prepare_lifetable(
  age_group = c(0, 5, 10, 15),
  population = c(3387900, 3401300, 3212300, 3026100),
  bhd = c(4727, 472, 557, 1323)
)
```

