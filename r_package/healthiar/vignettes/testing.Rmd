---
title: "testing"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{testing}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

------------------------------------------------------------------------

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

library(pacman)
pacman::p_load(healthiar, tibble, dplyr, purrr, tidyr, stringr, pillar, knitr, testthat, readxl)
options(knitr.kable.max_rows = 10)
set.seed(1)

```

## Prerequisite: access to the [BEST-COST GitHub repository](https://github.com/best-cost/best-cost_WPs)

If you don't have access yet, write to [alberto.castrofernandez\@swisstph.ch](mailto:alberto.castrofernandez@swisstph.ch){.email} or [axel.luyten\@swisstph.ch](mailto:axel.luyten@swisstph.ch){.email} and provide them with the email address of the GitHub account they should give access to.

## Prerequisite: newest version of `healthiar` installed

If you haven't already, install the most recent version of the BEST-COST R package healthiar. If you get prompted to update packages that `healthiar` uses and/or relies on, we advise to do so.

```{r install package, include=TRUE, echo=TRUE, eval=FALSE}
devtools::install_github(
  repo = "best-cost/best-cost_WPs", 
  subdir = "/r_package/healthiar", 
  ref = "HEAD", 
  build_vignettes = TRUE)
```

For more information on how to use the `healthiar` package, please see the vignette `intro_to_healthiar`: you can access it (once you have the `healthiar` package installed) in RStudio by

-   running `browseVignettes("healthiar")` in the console and clicking on *HTML* on the page that pops up
-   going to the *Packages* tab in RStudio, and clicking on `healthiar`\>*User guides, package vignettes and other documentation*\>*HTML*

------------------------------------------------------------------------

# Example: Adding a test

## 1. Pick a pathway

You want to make sure the results for the following calculation pathway are correct:

-   Relative risk

-   ERF shape: log-linear

-   Exposure: exposure distribution

-   With cutoff

-   No input variable uncertainty

-   No iteration

-   No multiexposure

So you claim this pathway by filling in your institution abbreviation and your name in the Excel [*pathways_overview*](https://ugentbe.sharepoint.com/:x:/r/teams/Group.PR202302461/Gedeelde%20documenten/WP4%20PROGRAMMING/testing_of_functions/pathways_overview.xlsx?d=w2da74c6a6e0146a5ba025ee050702838&csf=1&web=1&e=SkltuU) in the corresponding row.

In this case, it's the row with the `pathway_id` *pathway_rr\|erf_log_lin\|exp_single\|cutoff_TRUE\|varuncer_FALSE\|iteration_FALSE\|multiexp_FALSE\|*.

## 2. Look for comparison assessment

You remember that you've just assessed such a case recently! You dig up the assessment, both the input data and the results, and get set to add a test. In this case, the assessment details are saved in a .xlsx file (Excel file).

Of course, there are multiple possible sources of comparison assessments. These are, in order of decreasing preference:

1.  own assessment / calculations

2.  other studies / reports

3.  artificial intelligence, e.g. ChatGPT

4.  “fake” (but realistic) input data, to make sure calculation works (no error) and that results stay the same over time

## 3. Fill out the testing template with the assessment input data

You create a new R script (`.R` file) or RMarkdown (`.Rmd` file) for your test (please create one file for each test, if possible).

You select the appropriate template that Swiss TPH provided.

All testing templates can be found below in the section *Function templates*.

```{r template, include=TRUE, echo=TRUE, eval=FALSE}

testthat::test_that("results correct [pathway_id]", {
  
  ## IF APPLICABLE: LOAD INPUT DATA BEFORE RUNNING THE FUNCTION
  # data <- ...

  testthat::expect_equal(
    ## healthiar FUNCTION CALL
    object =
      healthiar::attribute_health(
        erf_shape = ,
        rr_central = ,
        rr_increment = ,
        exp_central = ,
        prop_pop_exp = ,
        cutoff_central = ,
        bhd_central = ,
        geo_id_disaggregated = ,
        geo_id_aggregated = ,
        approach_multiexposure = 
      ) |>
      healthiar::helper_extract_main_health_results(),
    ##  RESULT(S) FROM THE COMPARISON ASSESSMENT YOU SELECTED
    expected =
      c( )
    )
})

## ASSESSOR: Add here your name and your institute abbreviation
## ASSESSMENT DETAILS: Add here short description of the assessment: year, metric (e.g. DALY, premature deaths, ...), ...
## INPUT DATA DETAILS: Add here input data details: data sources, measured vs. modelled, ...

```

## 3.1 Add test details

In this example, we'll start by entering the `pathway_id` (which is found in the [*pathways_overview*](https://ugentbe.sharepoint.com/:x:/r/teams/Group.PR202302461/Gedeelde%20documenten/WP4%20PROGRAMMING/testing_of_functions/pathways_overview.xlsx?d=w2da74c6a6e0146a5ba025ee050702838&csf=1&web=1&e=SkltuU)Excel) to the first argument of the `testthat::test_that` call.

-   `pathway_id`: pathway_rr\|erf_log_lin\|exp_single\|cutoff_TRUE\|varuncer_FALSE\|iteration_FALSE\|multiexp_FALSE\|

So the test name is:

```{r add test name, include=TRUE, echo=TRUE, eval=FALSE}

testthat::test_that("results correct pathway_rr|erf_log_lin|exp_single|cutoff_TRUE|varuncer_FALSE|iteration_FALSE|multiexp_FALSE|", { ... })

```

Then we'll continue by adding other details. Optionally, you can also leave this until the end.

In case your comparison assessment has a DOI, please add it.

```{r add test details}

## ASSESSOR: Axel Luyten, Swiss TPH
## ASSESSMENT DETAILS: attribute DALYs from ischemic heart disease to road noise exposure
## INPUT DATA DETAILS: noise exposure data from NIPH; cutoff based on exposure data; baseline DALYs from GBD; relative risk from WHO (2003)

```

## 3.2 Enter input data & comparison results

Then you fill out the rest of the template using the input data of your selected assessment. There are two options:

1.  Enter the input data hard-coded

2.  Enter the input data by loading the data first into RStudio and then access it using the `$` operator

Depending on the assessment, one of the two might be better suited. We will first look at option 1, and then at option 2.

If you don't have much R programming experience, it's easiest to create the test with hard-coded inputs.

In case you load the input data before calling the `healthiar` function, please also upload the input data to the Teams testing folder of your institute, alongside the code for the test.

### 3.2.1 Test with hard-coded data

We can manually open the Excel file containing the assessment details, and then copy the relevant data into the template.

To see the Excel file used in this example, run `shell.exec(dirname(system.file("extdata", "example_road_noise_niph.xlsx", package = "healthiar")))`, which will open the folder containing the .xlsx file of the assessment.

Here's the filled out template with hard-coded input data (e.g. no external input data loaded).

```{r test with hard-coded inputs, include=TRUE, echo=TRUE, eval=TRUE}

testthat::test_that("results correct pathway_rr|erf_log_lin|exp_single|cutoff_TRUE|varuncer_FALSE|iteration_FALSE|multiexp_FALSE|", {

  testthat::expect_equal(
    ## healthiar FUNCTION CALL
    object =
      healthiar::attribute_health(
        erf_shape = "log_linear",
        rr_central = 1.08,
        rr_increment = 10,
        exp_central = c(53.0, 57.5, 62.5, 67.5, 72.5, 77.5),
        prop_pop_exp = c(0.818718312, 0.074319355, 0.054852478, 0.036785683, 0.013847374, 0.001476797),
        cutoff_central = 53,
        bhd_central = 85362.08,
        geo_id_disaggregated = NULL,
        geo_id_aggregated = NULL,
        approach_multiexposure = NULL
      ) |>
      healthiar::helper_extract_main_health_results(),
    ##  RESULT(S) FROM THE COMPARISON ASSESSMENT YOU SELECTED
    expected =
      c(1151)
    )
})

```

### 3.2.2. Test with loaded data

Another option is to load all your necessary input data (witing) before calling t

In case you select this approach, remember to also upload the input data to the Teams testing folder of your institute, alongside the code for the test.

```{r inspect excel file, eval=FALSE, include=FALSE, eval=FALSE}
# system.file("extdata", package = "healthiar") |> list.files()
# test <- readxl::read_xlsx(path = system.file("extdata", "example_road_noise_niph.xlsx", package = "healthiar"), sheet = "Relative_risk_IHD_WHO_2003a")
```

```{r test with loaded inputs, include=TRUE, echo=TRUE, eval=TRUE}

testthat::test_that("results correct results correct pathway_rr|erf_log_lin|exp_single|cutoff_TRUE|varuncer_FALSE|iteration_FALSE|multiexp_FALSE|", {

  ## IF APPLICABLE: LOAD INPUT DATA BEFORE RUNNING THE FUNCTION
  data_raw  <-  readxl::read_xlsx(
    path = system.file("extdata", "example_road_noise_niph.xlsx", package = "healthiar"),
    sheet = "Relative_risk_IHD_WHO_2003a")
  data  <- data_raw |>
    dplyr::filter(!is.na(data_raw$exposure_mean))
  
  testthat::expect_equal(
    ## healthiar FUNCTION CALL
    object =
      healthiar::attribute_health(
        erf_shape = "log_linear",
        rr_central = 1.08,
        rr_increment = 10,
        exp_central = data$exposure_mean,
        prop_pop_exp = data$prop_exposed,
        cutoff_central = min(data$exposure_mean),
        bhd_central = data$gbd_daly[1],
        geo_id_disaggregated = NULL,
        geo_id_aggregated = NULL,
        approach_multiexposure = NULL
        ) |>
      healthiar::helper_extract_main_health_results(),
    ##  RESULT(S) FROM THE COMPARISON ASSESSMENT YOU SELECTED
    expected =
      data_raw |>
      dplyr::filter(exposure_category %in% "Total exposed")|>
      dplyr::select(daly)|>
      dplyr::pull() |>
      round()
    )
})

```

## 4. Check whether results of healthiar and your chosen assessment are the same

```{r check results, include=TRUE, echo=FALSE, eval=TRUE}

testthat::test_that("results correct results correct pathway_rr|erf_log_lin|exp_single|cutoff_TRUE|varuncer_FALSE|iteration_FALSE|multiexp_FALSE|", {

  testthat::expect_equal(
    ## healthiar FUNCTION CALL
    object =
      healthiar::attribute_health(
        exp_central = c(53.0, 57.5, 62.5, 67.5, 72.5, 77.5),
        prop_pop_exp = c(0.818718312, 0.074319355, 0.054852478, 0.036785683, 0.013847374, 0.001476797),
        cutoff_central = 53,
        bhd_central = 85362.08,
        rr_central = 1.08,
        rr_increment = 10,
        erf_shape = "log_linear",
        geo_id_disaggregated = NULL,
        geo_id_aggregated = NULL,
        approach_multiexposure = NULL
      ) |>
      healthiar::helper_extract_main_health_results(),
    ##  RESULT(S) FROM THE COMPARISON ASSESSMENT YOU SELECTED
    expected =
      c(1151)
    )
})


## ASSESSOR: Axel Luyten, Swiss TPH
## ASSESSMENT DETAILS: attribute DALYs from ischemic heart disease to road noise exposure
## INPUT DATA DETAILS: noise exposure data from NIPH; cutoff based on exposure data; baseline DALYs from GBD; relative risk from WHO (2003)

```

Yes, they are the same.

In case there is a deviation try to judge what could cause the difference. Please alert Alberto and Axel in case that there is a deviation between the \`healthiar\` result and the comparison case result.

## 5. Upload the test

You upload your test with the `pathway_id` as the file name to the [Teams folder WP4 PROGRAMMING\>testing_of_functions](https://ugentbe.sharepoint.com/:f:/r/teams/Group.PR202302461/Gedeelde%20documenten/WP4%20PROGRAMMING/testing_of_functions?csf=1&web=1&e=hT3jaK) to the folder of your institute.

Then change the value in the column *finished* in the Excel [*pathways_overview*](https://ugentbe.sharepoint.com/:x:/r/teams/Group.PR202302461/Gedeelde%20documenten/WP4%20PROGRAMMING/testing_of_functions/pathways_overview.xlsx?d=w2da74c6a6e0146a5ba025ee050702838&csf=1&web=1&e=SkltuU) from *FALSE* to *TRUE*, and indicate whether whether the results of healthiar and your chosen comparison assessment are the same in the column *results_the_same* (*TRUE* or *FALSE*).

------------------------------------------------------------------------

# Testing templates

## Relative risk pathways

Depending on your calculation pathway you will have to replace some of the `NULL` values in the template.

```{r template rr complete, include=TRUE, echo=TRUE, eval=FALSE}

testthat::test_that("results correct [pathway_id]", {
  
  ## IF APPLICABLE: LOAD INPUT DATA BEFORE RUNNING THE FUNCTION
  # data <- ...

  testthat::expect_equal(
    ## healthiar FUNCTION CALL
    object =
      healthiar::attribute_health(
        approach_risk = "relative_risk",
        erf_shape = ,
        rr_central = ,
        rr_lower = NULL, 
        rr_upper = NULL,
        rr_increment = ,
        exp_central = ,
        exp_lower = NULL, 
        exp_upper = NULL,
        cutoff_central = ,
        cutoff_lower = NULL, 
        cutoff_upper = NULL,
        bhd_central = ,
        bhd_lower = NULL, 
        bhd_upper = NULL,
        geo_id_disaggregated = NULL,
        geo_id_aggregated = NULL,
        approach_multiexposure = NULL
      ) |>
      healthiar::helper_extract_main_health_results(),
    ##  RESULT(S) FROM THE COMPARISON ASSESSMENT YOU SELECTED
    expected =
      c( )
    )
})

## ASSESSOR: Add here your name and your institute abbreviation
## ASSESSMENT DETAILS: Add here short description of the assessment: year, metric (e.g. DALY, premature deaths, ...), ...
## INPUT DATA DETAILS: Add here input data details: data sources, measured vs. modelled, ...

```

## Absolute risk pathways

Depending on your calculation pathway you will have to replace some of the `NULL` values in the template.

```{r template ar complete, include=TRUE, echo=TRUE, eval=FALSE}

testthat::test_that("results correct [pathway_id]", {
  
  ## IF APPLICABLE: LOAD INPUT DATA BEFORE RUNNING THE FUNCTION
  # data <- ...

  testthat::expect_equal(
    ## healthiar FUNCTION CALL
    object =
      healthiar::attribute_health(
        approach_risk = "absolute_risk",
        erf_eq_central = ,
        erf_eq_lower = NULL,
        erf_eq_upper = NULL,
        exp_central = ,
        exp_lower = NULL, 
        exp_upper = NULL,
        cutoff_central = ,
        cutoff_lower = NULL, 
        cutoff_upper = NULL,
        population = ,
        prop_pop_exp = ,
        geo_id_disaggregated = NULL,
        geo_id_aggregated = NULL,
        approach_multiexposure = NULL
      ) |>
      healthiar::helper_extract_main_health_results(),
    ##  RESULT(S) FROM THE COMPARISON ASSESSMENT YOU SELECTED
    expected =
      c( )
    )
})

## ASSESSOR: Add here your name and your institute abbreviation
## ASSESSMENT DETAILS: Add here short description of the assessment: year, metric (e.g. DALY, premature deaths, ...), ...
## INPUT DATA DETAILS: Add here input data details: data sources, measured vs. modelled, ...

```

## Cost-benefit analysis pathways

Depending on your calculation pathway you will have to replace some of the `NULL` values in the template.

```{r template cba complete, include=TRUE, echo=TRUE, eval=FALSE}

testthat::test_that("results correct [pathway_id]", {
  
  ## IF APPLICABLE: LOAD INPUT DATA BEFORE RUNNING THE FUNCTION
  # data <- ...

  testthat::expect_equal(
    ## healthiar FUNCTION CALL
    object =
      healthiar::include_cba(
        approach_discount = ,
        output_healthiar = NULL,
        positive_impact = ,
        valuation = ,
        cost = ,
        discount_shape = ,
        discount_rate_benefit = ,
        discount_rate_cost = ,
        discount_years_benefit = 1,
        discount_years_cost = 1,
        discount_overtime =  # only applicable if approach_discount is "direct" 
        ) |>
      healthiar::helper_extract_main_cba_results(),
    ##  RESULT(S) FROM THE COMPARISON ASSESSMENT YOU SELECTED
    expected =
      c( )
    )
})

## ASSESSOR: Add here your name and your institute abbreviation
## ASSESSMENT DETAILS: Add here short description of the assessment: year, metric (e.g. DALY, premature deaths, ...), ...
## INPUT DATA DETAILS: Add here input data details: data sources, measured vs. modelled, ...

```
