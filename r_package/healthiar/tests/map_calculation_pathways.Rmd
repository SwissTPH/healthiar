---
title: "map_calculation_pathtways"
author: "Axel Luyten"
output: html_document
---

Goal:
Map 
- core
- all
calculation pathways covered by healthiar to keep track of testing progress.
Core pathways should be all covered by tests.
All pathways overview gives us an idea of how much we've covered.

# Setup

```{r setup}

pacman::p_load(dplyr, tibble, stringr, purrr)

```

# RR

```{r RR pathways}

# * Define all relevant pathways ###############################################
## Create tibble containing (almost) all possible calculation pathways
pathways_rr <- list(
  erf = c("log_lin", "function", "formula", "lin_lin", "lin_log", "log_log"),
  exp = c("single", "dist"), # prop_pop_exp linked with this
  iteration = c("TRUE", "FALSE")
)

pathways_rr <- expand.grid(pathways_rr) |> 
  tibble::as_tibble() |>
  mutate_all(as.character) %>% # IMPORTANT TO USE magrittr PIPE
  ## Create all pathway ID's
  mutate(
    pathway_id = purrr::pmap_chr(., function(...) {
      vals <- list(...)
paste0("|pathway_rr|", paste(names(vals), vals, sep = "_", collapse = "|"), "|")
})
  ) 

#* Define core pathways ########################################################
core_rr <- list(
  erf = c("log_lin", "function", "lin_lin"),
  exp = c("single", "dist"), # prop_pop_exp linked with this
  iteration = c("TRUE", "FALSE")
)

core_rr <- expand.grid(core_rr) |> 
  tibble::as_tibble() |>
  mutate_all(as.character) |> 
  mutate(core_pathway = "TRUE")

## Merge core pathways into whole overview
pathways_rr <- pathways_rr |> 
  left_join(x = _, y = core_rr, by = c("erf", "exp", "iteration")) |> 
  mutate(core_pathway = ifelse(is.na(core_pathway), "FALSE", core_pathway)) |> 
  mutate(implemented = "FALSE")
rm(core_rr)

# * Document existing pathways #################################################

file_path <- "../healthiar/tests/testthat/test-attribute_health.R"
file_content <- readLines(file_path) # String vector where each element is all code from a line

test_names <- regmatches(file_content, gregexpr('testthat::test_that\\("\\K[^"]+(?=", \\{)', file_content, perl = TRUE))
test_names_with_pw <- Filter(function(x) any(grepl("\\|pathway_rr\\|", x)), test_names)


## Create an empty tibble with NA placeholders
n_row <- length(test_names_with_pw)
existing_tests <- tibble(
  erf = rep(NA_character_, n_row),
  exp = rep(NA_character_, n_row),
  iteration = rep(NA_character_, n_row),
  implemented = rep(FALSE, n_row)
)

## Extract values and assign them directly to the tibble
for (i in seq_along(test_names_with_pw)) {
  strings <- test_names_with_pw[[i]] # Current list item

  # Extract values for each column
  existing_tests$exp[i] <- str_extract(strings[str_detect(strings, "\\|exp_")], "(?<=\\|exp_)[^\\|]+")
  existing_tests$erf[i] <- str_extract(strings[str_detect(strings, "\\|erf_")], "(?<=\\|erf_)[^\\|]+")
  existing_tests$iteration[i] <- str_extract(strings[str_detect(strings, "\\|iteration_")], "(?<=\\|iteration_)[^\\|]+")
  existing_tests$implemented[i] <- "TRUE"
}

## Merge the whole pathways tibble and the existing_tests tibble
pathways_rr <- pathways_rr %>%
  left_join(existing_tests, by = c("erf", "exp", "iteration"),
            suffix = c("", ".existing")) %>%
  mutate(implemented = coalesce(implemented.existing, implemented)) %>%
  select(-starts_with("implemented.existing")) |> 
  distinct() # Removes duplicate rows (rows that have the same pathway ID)

## Rearrange columns
pathways_rr <- pathways_rr |> 
  relocate(implemented) |> 
  relocate(core_pathway, .after = implemented) |> 
  arrange(desc(implemented), desc(core_pathway), erf, desc(exp), desc(iteration))

# * Measure progress ###########################################################

## Create RR current testing state overview
progress_rr <-
  tibble(
    domain = "RR",
    n_implemented = nrow(pathways_rr |> filter(implemented == TRUE)),
    `%_of_core` = 
      paste0(
        round(
          pathways_rr |> filter(implemented== "TRUE") |> nrow() / 
            nrow(pathways_rr |> filter(core_pathway == "TRUE")) * 100, 
          digits = 0
        ),
        " %"),
    `%_of_total` = paste0(
        round(
          pathways_rr |> filter(implemented== "TRUE") |> nrow() / 
            nrow(pathways_rr) * 100, 
          digits = 0
        ),
        " %"),
    n_core_pw = nrow(pathways_rr |> filter(core_pathway == "TRUE")),
    n_all_pw = nrow(pathways_rr)
  )

## Output short report
cat("Number of RR pathways implemented as tests:", progress_rr$n_implemented, "\n")
cat("% of core pathways:", progress_rr$`%_of_core`, "\n")
cat("% of all pathways:", progress_rr$`%_of_total`, "\n")
cat("Total number core of pathways:", progress_rr$n_core_pw, "\n")
cat("Total number of pathways:", progress_rr$n_all_pw, "\n")

```

# AR

```{r AR pathways}

# * Define all relevant pathways ###############################################
## Create tibble containing (almost) all possible calculation pathways
pathways_ar <- list(
  erf = c("formula", "function"),
  exp = c("dist"), # prop_pop_exp linked with this
  iteration = c("TRUE", "FALSE")
)

pathways_ar <- expand.grid(pathways_ar) |> 
  tibble::as_tibble() |>
  mutate_all(as.character) %>% # IMPORTANT TO USE magrittr PIPE
  ## Create all pathway ID's
  mutate(
    pathway_id = purrr::pmap_chr(., function(...) {
      vals <- list(...)
paste0("|pathway_ar|", paste(names(vals), vals, sep = "_", collapse = "|"), "|")
})
  ) 

#* Define core pathways ########################################################
core_ar <- list(
  erf = c("formula", "function"),
  exp = c("dist"), # prop_pop_exp linked with this
  iteration = c("TRUE", "FALSE")
)

core_ar <- expand.grid(core_ar) |> 
  tibble::as_tibble() |>
  mutate_all(as.character) |> 
  mutate(core_pathway = "TRUE")

pathways_ar <- pathways_ar |> 
  left_join(x = _, y = core_ar, by = c("erf", "exp", "iteration")) |> 
  mutate(core_pathway = ifelse(is.na(core_pathway), "FALSE", core_pathway)) |> 
  mutate(implemented = "FALSE")

# * Document existing pathways #################################################
file_path <- "../healthiar/tests/testthat/test-attribute_health.R"
file_content <- readLines(file_path) # String vector where each element is all code from a line

test_names <- regmatches(file_content, gregexpr('testthat::test_that\\("\\K[^"]+(?=", \\{)', file_content, perl = TRUE))
test_names_with_pw <- Filter(function(x) any(grepl("\\|pathway_ar\\|", x)), test_names)


## Create an empty tibble with NA placeholders
n_row <- length(test_names_with_pw)
existing_tests <- tibble(
  erf = rep(NA_character_, n_row),
  exp = rep(NA_character_, n_row),
  iteration = rep(NA_character_, n_row),
  implemented = rep(FALSE, n_row)
)

## Extract values and assign them directly to the tibble
for (i in seq_along(test_names_with_pw)) {
  strings <- test_names_with_pw[[i]] # Current list item

  # Extract values for each column
  existing_tests$exp[i] <- str_extract(strings[str_detect(strings, "\\|exp_")], "(?<=\\|exp_)[^\\|]+")
  existing_tests$erf[i] <- str_extract(strings[str_detect(strings, "\\|erf_")], "(?<=\\|erf_)[^\\|]+")
  existing_tests$iteration[i] <- str_extract(strings[str_detect(strings, "\\|iteration_")], "(?<=\\|iteration_)[^\\|]+")
  existing_tests$implemented[i] <- "TRUE"
}

## Merge the pathways tibble and the existing_tests tibble
pathways_ar <- pathways_ar %>%
  left_join(existing_tests, by = c("erf", "exp", "iteration"),
            suffix = c("", ".existing")) %>%
  mutate(implemented = coalesce(implemented.existing, implemented)) %>%
  select(-implemented.existing) |> 
  distinct() # Removes duplicate rows (rows that have the same pathway ID)

## Rearrange columns
pathways_ar <- pathways_ar |> 
  relocate(implemented) |> 
  relocate(core_pathway, .after = implemented) |> 
  arrange(desc(implemented), desc(core_pathway), erf, desc(exp), desc(iteration))

# * Measure progress ###########################################################

## Create AR current testing state overview
progress_ar <-
  tibble(
    domain = "AR",
    n_implemented = nrow(pathways_ar |> filter(implemented == TRUE)),
    `%_of_core` = 
      paste0(
        round(
          pathways_ar |> filter(implemented== "TRUE") |> nrow() / 
            nrow(pathways_ar |> filter(core_pathway == "TRUE")) * 100, 
          digits = 0
        ),
        " %"),
    `%_of_total` = paste0(
        round(
          pathways_ar |> filter(implemented== "TRUE") |> nrow() / 
            nrow(pathways_ar) * 100, 
          digits = 0
        ),
        " %"),
    n_core_pw = nrow(pathways_ar |> filter(core_pathway == "TRUE")),
    n_all_pw = nrow(pathways_ar)
  )

## Output short report
cat("Number of AR pathways implemented as tests:", progress_ar$n_implemented, "\n")
cat("% of core pathways:", progress_ar$`%_of_core`, "\n")
cat("% of all pathways:", progress_ar$`%_of_total`, "\n")
cat("Total number core of pathways:", progress_ar$n_core_pw, "\n")
cat("Total number of pathways:", progress_ar$n_all_pw, "\n")
```

# summarize uncertainty

```{r Pathways summary uncertainty}

ov_uncertainty <- list(
  exp = c("single", "dist"),
  erf = c("rr_increment", "rr_formula", "rr_function", "ar_formula", "ar_function"),
  iteration = c("TRUE", "FALSE")
)

pathways_uncertainty <- expand.grid(ov_uncertainty)|> 
  tibble::as_tibble() |>
  mutate_all(as.character)

pathways_uncertainty <- pathways_uncertainty %>% # Important to use magrittr pipe
  mutate(
    pathway_id = purrr::pmap_chr(., function(...) {
      vals <- list(...)
      paste0("|pathway_uncertainty|", paste(names(vals), vals, sep = "_", collapse = "|"), "|")
    })
  )

#* Define core pathways ########################################################

core_uncertainty <- list(
  exp = c("single", "dist"),
  erf = c("rr_increment", "rr_formula", "rr_function", "ar_formula", "ar_function"),
  iteration = c("TRUE", "FALSE")
)

core_uncertainty <- expand.grid(core_uncertainty) |> 
  tibble::as_tibble() |>
  mutate_all(as.character) |> 
  mutate(core_pathway = "TRUE")

pathways_uncertainty <- pathways_uncertainty |> 
  left_join(x = _, y = core_uncertainty, by = c("exp", "erf", "iteration")) |> 
  mutate(core_pathway = ifelse(is.na(core_pathway), "FALSE", core_pathway)) |> 
  mutate(implemented = "FALSE")

# * Document existing pathways ####

file_path <- "../healthiar/tests/testthat/test-summarize_uncertainty.R"
file_content <- readLines(file_path) # String vector where each element is all code from a line

test_names <- regmatches(file_content, gregexpr('testthat::test_that\\("\\K[^"]+(?=", \\{)', file_content, perl = TRUE))
test_names_with_pw <- Filter(function(x) any(grepl("\\|pathway_uncertainty\\|", x)), test_names)


## Create an empty tibble with NA placeholders
n_row <- length(test_names_with_pw)
existing_tests <- tibble(
  exp = rep(NA_character_, n_row),
  erf = rep(NA_character_, n_row),
  iteration = rep(NA_character_, n_row),
  implemented = rep("FALSE", n_row)
)

## Extract values and assign them directly to the tibble
for (i in seq_along(test_names_with_pw)) {
  strings <- test_names_with_pw[[i]] # Current list item

  # Extract values for each column
  existing_tests$exp[i] <- str_extract(strings[str_detect(strings, "\\|exp_")], "(?<=\\|exp_)[^\\|]+")
  existing_tests$erf[i] <- str_extract(strings[str_detect(strings, "\\|erf_")], "(?<=\\|erf_)[^\\|]+")
  existing_tests$iteration[i] <- str_extract(strings[str_detect(strings, "\\|iteration_")], "(?<=\\|iteration_)[^\\|]+")
  
  existing_tests$implemented[i] <- "TRUE"
}

## Merge the pathways tibble and the existing_tests tibble
pathways_uncertainty <- pathways_uncertainty %>%
  left_join(existing_tests, by = c("exp", "erf", "iteration"),
            suffix = c("", ".existing")) %>%
  mutate(implemented = coalesce(implemented.existing, implemented)) %>%
  select(-implemented.existing) |> 
  distinct() # Removes duplicate rows (rows that have the same pathway ID)

## Rearrange columns
pathways_uncertainty <- pathways_uncertainty |> 
  relocate(implemented) |> 
  relocate(core_pathway, .after = implemented) |> 
  arrange(desc(implemented), desc(core_pathway), desc(erf), desc(exp), desc(iteration))

# * Measure progress ###########################################################

## Create uncertainty current testing state overview
progress_uncertainty <-
  tibble(
    domain = "summary uncertainty",
    n_implemented = nrow(pathways_uncertainty |> filter(implemented == TRUE)),
    `%_of_core` = 
      paste0(
        round(
          pathways_uncertainty |> filter(implemented== "TRUE") |> nrow() / 
            nrow(pathways_uncertainty |> filter(core_pathway == "TRUE")) * 100, 
          digits = 0
        ),
        " %"),
    `%_of_total` = paste0(
        round(
          pathways_uncertainty |> filter(implemented== "TRUE") |> nrow() / 
            nrow(pathways_uncertainty) * 100, 
          digits = 0
        ),
        " %"),
    n_core_pw = nrow(pathways_uncertainty |> filter(core_pathway == "TRUE")),
    n_all_pw = nrow(pathways_uncertainty)
  )

## Output short report
cat("Number of summary uncertainty pathways implemented as tests:", progress_uncertainty$n_implemented, "\n")
cat("% of core pathways:", progress_uncertainty$`%_of_core`, "\n")
cat("% of all pathways:", progress_uncertainty$`%_of_total`, "\n")
cat("Total number core of pathways:", progress_uncertainty$n_core_pw, "\n")
cat("Total number of pathways:", progress_uncertainty$n_all_pw, "\n")
```

# compare

```{r Pathways compare}

# * Define all relevant pathways ###############################################
## Create tibble containing (almost) all possible calculation pathways
pathways_compare <- list(
  comp_appr = c("delta", "pif"),
  exp = c("single", "dist"), # prop_pop_exp linked with this
  iteration = c("TRUE", "FALSE")
)

pathways_compare <- expand.grid(pathways_compare) |> 
  tibble::as_tibble() |>
  mutate_all(as.character) %>% # IMPORTANT TO USE magrittr PIPE
  ## Create all pathway ID's
  mutate(
    pathway_id = purrr::pmap_chr(., function(...) {
      vals <- list(...)
paste0("|pathway_compare|", paste(names(vals), vals, sep = "_", collapse = "|"), "|")
})
  ) 

#* Define core pathways ########################################################
core_compare <- list(
  comp_appr = c("delta", "pif"),
  exp = c("single", "dist"),
  iteration = c("TRUE", "FALSE")
)

core_compare <- expand.grid(core_compare) |> 
  tibble::as_tibble() |>
  mutate_all(as.character) |> 
  mutate(core_pathway = "TRUE")

pathways_compare <- pathways_compare |> 
  left_join(x = _, y = core_compare, by = c("comp_appr", "exp", "iteration")) |> 
  mutate(core_pathway = ifelse(is.na(core_pathway), "FALSE", core_pathway)) |> 
  mutate(implemented = "FALSE")

# * Document existing pathways #################################################
file_path <- "../healthiar/tests/testthat/test-compare.R"
file_content <- readLines(file_path) # String vector where each element is all code from a line

test_names <- regmatches(file_content, gregexpr('testthat::test_that\\("\\K[^"]+(?=", \\{)', file_content, perl = TRUE))
test_names_with_pw <- Filter(function(x) any(grepl("\\|pathway_compare\\|", x)), test_names)


## Create an empty tibble with NA placeholders
n_row <- length(test_names_with_pw)
existing_tests <- tibble(
  comp_appr = rep(NA_character_, n_row),
  exp = rep(NA_character_, n_row),
  iteration = rep(NA_character_, n_row),
  implemented = rep(FALSE, n_row)
)

## Extract values and assign them directly to the tibble
for (i in seq_along(test_names_with_pw)) {
  strings <- test_names_with_pw[[i]] # Current list item

  # Extract values for each column
  existing_tests$comp_appr[i] <- str_extract(strings[str_detect(strings, "\\|comp_appr_")], "(?<=\\|comp_appr_)[^\\|]+")
  existing_tests$exp[i] <- str_extract(strings[str_detect(strings, "\\|exp_")], "(?<=\\|exp_)[^\\|]+")
  existing_tests$iteration[i] <- str_extract(strings[str_detect(strings, "\\|iteration_")], "(?<=\\|iteration_)[^\\|]+")
  existing_tests$implemented[i] <- "TRUE"
}

## Merge the pathways tibble and the existing_tests tibble
pathways_compare <- pathways_compare %>%
  left_join(existing_tests, by = c("comp_appr", "exp", "iteration"),
            suffix = c("", ".existing")) %>%
  mutate(implemented = coalesce(implemented.existing, implemented)) %>%
  select(-implemented.existing) |> 
  distinct() # Removes duplicate rows (rows that have the same pathway ID)

## Rearrange columns
pathways_compare <- pathways_compare |> 
  relocate(implemented) |> 
  relocate(core_pathway, .after = implemented) |> 
  arrange(desc(implemented), desc(core_pathway), comp_appr, desc(exp), desc(iteration))

# * Measure progress ###########################################################

## Create comparison current testing state overview
progress_compare <-
  tibble(
    domain = "comparison",
    n_implemented = nrow(pathways_compare |> filter(implemented == TRUE)),
    `%_of_core` = 
      paste0(
        round(
          pathways_compare |> filter(implemented== "TRUE") |> nrow() / 
            nrow(pathways_compare |> filter(core_pathway == "TRUE")) * 100, 
          digits = 0
        ),
        " %"),
    `%_of_total` = paste0(
        round(
          pathways_compare |> filter(implemented== "TRUE") |> nrow() / 
            nrow(pathways_compare) * 100, 
          digits = 0
        ),
        " %"),
    n_core_pw = nrow(pathways_compare |> filter(core_pathway == "TRUE")),
    n_all_pw = nrow(pathways_compare)
  )

## Output short report
cat("Number of comparison pathways implemented as tests:", progress_compare$n_implemented, "\n")
cat("% of core pathways:", progress_compare$`%_of_core`, "\n")
cat("% of all pathways:", progress_compare$`%_of_total`, "\n")
cat("Total number core of pathways:", progress_compare$n_core_pw, "\n")
cat("Total number of pathways:", progress_compare$n_all_pw, "\n")
```

# monetize

```{r Pathways monetization}

ov_monetization <- list(
  discount_rate = c("TRUE", "FALSE"),
  discount_shape = c("exponential", "hyp_harvey", "hyp_mazur"),
  inflation = c("TRUE", "FALSE")
)

pathways_monetization <- expand.grid(ov_monetization) |> 
  tibble::as_tibble() |>
  mutate_all(as.character)

pathways_monetization <- pathways_monetization %>% # Important to use magrittr pipe
  mutate(
    pathway_id = purrr::pmap_chr(., function(...) {
      vals <- list(...)
      paste0("|pathway_monetization|", paste(names(vals), vals, sep = "_", collapse = "|"), "|")
    })
  ) 

#* Define core pathways ########################################################
core_monetization <- list(
  discount_shape = c("exponential", "hyp_harvey", "hyp_mazur"),
  discount_rate = c("TRUE", "FALSE"),
  inflation = c("TRUE", "FALSE")
)

core_monetization <- expand.grid(core_monetization) |> 
  tibble::as_tibble() |>
  mutate_all(as.character) |> 
  mutate(core_pathway = "TRUE")

pathways_monetization <- pathways_monetization |> 
  left_join(x = _, y = core_monetization, by = c("discount_shape", "discount_rate", "inflation")) |> 
  mutate(core_pathway = ifelse(is.na(core_pathway), "FALSE", core_pathway)) |> 
  mutate(implemented = "FALSE")

# * Document existing pathways ####

file_path <- "../healthiar/tests/testthat/test-monetize.R"
file_content <- readLines(file_path) # String vector where each element is all code from a line

test_names <- regmatches(file_content, gregexpr('testthat::test_that\\("\\K[^"]+(?=", \\{)', file_content, perl = TRUE))
test_names_with_pw <- Filter(function(x) any(grepl("\\|pathway_monetization\\|", x)), test_names)


## Create an empty tibble with NA placeholders
n_row <- length(test_names_with_pw)
existing_tests <- tibble(
  discount_rate = rep(NA_character_, n_row),
  discount_shape = rep(NA_character_, n_row),
  inflation = rep(NA_character_, n_row),
  implemented = rep("FALSE", n_row)
)

## Extract values and assign them directly to the tibble
for (i in seq_along(test_names_with_pw)) {
  strings <- test_names_with_pw[[i]] # Current list item

  # Extract values for each column
  existing_tests$discount_rate[i] <- str_extract(strings[str_detect(strings, "\\|discount_rate_")], "(?<=\\|discount_rate_)[^\\|]+")
  existing_tests$discount_shape[i] <- str_extract(strings[str_detect(strings, "\\|discount_shape_")], "(?<=\\|discount_shape_)[^\\|]+")
  existing_tests$inflation[i] <- str_extract(strings[str_detect(strings, "\\|inflation_")], "(?<=\\|inflation_)[^\\|]+")
  
  existing_tests$implemented[i] <- "TRUE"
}

## Merge the pathways tibble and the existing_tests tibble
pathways_monetization <- pathways_monetization %>%
  left_join(existing_tests, by = c("discount_shape", "discount_rate", "inflation"),
            suffix = c("", ".existing")) %>%
  mutate(implemented = coalesce(implemented.existing, implemented)) %>%
  select(-implemented.existing)|> 
  distinct() # Removes duplicate rows (rows that have the same pathway ID)

## Rearrange columns
pathways_monetization <- pathways_monetization |> 
  relocate(implemented) |> 
  relocate(core_pathway, .after = implemented) |> 
  arrange(desc(discount_rate), discount_shape, inflation)

# * Measure progress ###########################################################

## Create monetization current testing state overview
progress_monetization <-
  tibble(
    domain = "monetization",
    n_implemented = nrow(pathways_monetization |> filter(implemented == TRUE)),
    `%_of_core` = 
      paste0(
        round(
          pathways_monetization |> filter(implemented== "TRUE") |> nrow() / 
            nrow(pathways_monetization |> filter(core_pathway == "TRUE")) * 100, 
          digits = 0
        ),
        " %"),
    `%_of_total` = paste0(
        round(
          pathways_monetization |> filter(implemented== "TRUE") |> nrow() / 
            nrow(pathways_monetization) * 100, 
          digits = 0
        ),
        " %"),
    n_core_pw = nrow(pathways_monetization |> filter(core_pathway == "TRUE")),
    n_all_pw = nrow(pathways_monetization)
  )

## Output short report
cat("Number of monetization pathways implemented as tests:", progress_monetization$n_implemented, "\n")
cat("% of core pathways:", progress_monetization$`%_of_core`, "\n")
cat("% of all pathways:", progress_monetization$`%_of_total`, "\n")
cat("Total number core of pathways:", progress_monetization$n_core_pw, "\n")
cat("Total number of pathways:", progress_monetization$n_all_pw, "\n")

```

# CBA

```{r Pathways cba}

pathways_cba <- list(
  discount_shape = c("exponential", "hyp_harvey", "hyp_mazur"),
  discount_rate_benefit = c("TRUE", "FALSE"),
  discount_rate_cost = c("TRUE", "FALSE")
)

pathways_cba <- expand.grid(pathways_cba) |>
  tibble::as_tibble() |>
  mutate_all(as.character)

pathways_cba <- pathways_cba %>% # Important to use magrittr pipe
  mutate(
    pathway_id = purrr::pmap_chr(., function(...) {
      vals <- list(...)
      paste0("|pathway_cba|", paste(names(vals), vals, sep = "_", collapse = "|"), "|")
    })
  ) 
  
#* Define core pathways ########################################################
core_cba <- list(
  discount_rate_benefit = c("TRUE", "FALSE"),
  discount_rate_cost = c("TRUE", "FALSE"),
  discount_shape = c("exponential", "hyp_harvey", "hyp_mazur")
)

core_cba <- expand.grid(core_cba) |> 
  tibble::as_tibble() |>
  mutate_all(as.character) |> 
  mutate(core_pathway = "TRUE")

pathways_cba <- pathways_cba |> 
  left_join(x = _, y = core_cba, by = c("discount_shape", "discount_rate_benefit", "discount_rate_cost")) |> 
  mutate(core_pathway = ifelse(is.na(core_pathway), "FALSE", core_pathway)) |> 
  mutate(implemented = "FALSE")

# * Document existing pathways #################################################
file_path <- "../healthiar/tests/testthat/test-cba.R"
file_content <- readLines(file_path) # String vector where each element is all code from a line

test_names <- regmatches(file_content, gregexpr('testthat::test_that\\("\\K[^"]+(?=", \\{)', file_content, perl = TRUE))
test_names_with_pw <- Filter(function(x) any(grepl("\\|pathway_cba\\|", x)), test_names)


## Create an empty tibble with NA placeholders
n_row <- length(test_names_with_pw)
existing_tests <- tibble(
  discount_rate_benefit = rep(NA_character_, n_row),
  discount_rate_cost = rep(NA_character_, n_row),
  discount_shape = rep(NA_character_, n_row),
  implemented = rep("FALSE", n_row)
)

## Extract values and assign them directly to the tibble
for (i in seq_along(test_names_with_pw)) {
  strings <- test_names_with_pw[[i]] # Current list item

  # Extract values for each column
  existing_tests$discount_rate_benefit[i] <- str_extract(strings[str_detect(strings, "\\|discount_rate_benefit_")], "(?<=\\|discount_rate_benefit_)[^\\|]+")
  existing_tests$discount_rate_cost[i] <- str_extract(strings[str_detect(strings, "\\|discount_rate_cost_")], "(?<=\\|discount_rate_cost_)[^\\|]+")
  existing_tests$discount_shape[i] <- str_extract(strings[str_detect(strings, "\\|discount_shape_")], "(?<=\\|discount_shape_)[^\\|]+")
  
  
  existing_tests$implemented[i] <- "TRUE"
}

## Merge the pathways tibble and the existing_tests tibble
pathways_cba <- pathways_cba %>%
  left_join(existing_tests, by = c("discount_shape", "discount_rate_benefit", "discount_rate_cost"),
            suffix = c("", ".existing")) %>%
  mutate(implemented = coalesce(implemented.existing, implemented)) %>%
  select(-implemented.existing) |> 
  distinct() # Removes duplicate rows (rows that have the same pathway ID)

## Rearrange columns
pathways_cba <- pathways_cba |> 
  relocate(implemented) |> 
  relocate(core_pathway, .after = implemented) |> 
  arrange(desc(discount_rate_benefit), desc(discount_rate_cost), discount_shape)

# * Measure progress ###########################################################

## Create CBA current testing state overview
progress_cba <-
  tibble(
    domain = "CBA",
    n_implemented = nrow(pathways_cba |> filter(implemented == TRUE)),
    `%_of_core` = 
      paste0(
        round(
          pathways_cba |> filter(implemented== "TRUE") |> nrow() / 
            nrow(pathways_cba |> filter(core_pathway == "TRUE")) * 100, 
          digits = 0
        ),
        " %"),
    `%_of_total` = paste0(
        round(
          pathways_cba |> filter(implemented== "TRUE") |> nrow() / 
            nrow(pathways_cba) * 100, 
          digits = 0
        ),
        " %"),
    n_core_pw = nrow(pathways_cba |> filter(core_pathway == "TRUE")),
    n_all_pw = nrow(pathways_cba)
  )

## Output short report
cat("Number of CBA pathways implemented as tests:", progress_cba$n_implemented, "\n")
cat("% of core pathways:", progress_cba$`%_of_core`, "\n")
cat("% of all pathways:", progress_cba$`%_of_total`, "\n")
cat("Total number core of pathways:", progress_cba$n_core_pw, "\n")
cat("Total number of pathways:", progress_cba$n_all_pw, "\n")

```

# DALY

All pathways are core pathways

```{r Pathways DALY}

# * Define all relevant pathways ###############################################
## Create tibble containing (almost) all possible calculation pathways
pathways_daly <- list(
  yll_from_lifetable = c("TRUE", "FALSE"),
  output_1_type = c("attribute", "compare"),
  output_2_type = c("attribute", "compare")
)

pathways_daly <- expand.grid(pathways_daly) |> 
  tibble::as_tibble() |>
  mutate_all(as.character) %>% # IMPORTANT TO USE magrittr PIPE
  ## Create all pathway ID's
  mutate(
    pathway_id = purrr::pmap_chr(., function(...) {
      vals <- list(...)
paste0("|pathway_daly|", paste(names(vals), vals, sep = "_", collapse = "|"), "|")
})
  )
  
#* Define core pathways ########################################################
core_daly <- list(
  yll_from_lifetable = c("TRUE", "FALSE"),
  output_1_type = c("attribute", "compare"),
  output_2_type = c("attribute", "compare")
)

core_daly <- expand.grid(core_daly) |> 
  tibble::as_tibble() |>
  mutate_all(as.character) |> 
  mutate(core_pathway = "TRUE")

pathways_daly <- pathways_daly |> 
  left_join(x = _, y = core_daly, by = c("yll_from_lifetable", "output_1_type", "output_2_type")) |> 
  mutate(core_pathway = ifelse(is.na(core_pathway), "FALSE", core_pathway)) |> 
  mutate(implemented = "FALSE")

# * Document existing pathways #################################################
file_path <- "../healthiar/tests/testthat/test-daly.R"
file_content <- readLines(file_path) # String vector where each element is all code from a line

test_names <- regmatches(file_content, gregexpr('testthat::test_that\\("\\K[^"]+(?=", \\{)', file_content, perl = TRUE))
test_names_with_pw <- Filter(function(x) any(grepl("\\|pathway_daly\\|", x)), test_names)

## Create an empty tibble with NA placeholders
n_row <- length(test_names_with_pw)
existing_tests <- tibble(
  yll_from_lifetable = rep(NA_character_, n_row),
  output_1_type = rep(NA_character_, n_row),
  output_2_type = rep(NA_character_, n_row),
  implemented = rep("FALSE", n_row)
)

## Extract values and assign them directly to the tibble
for (i in seq_along(test_names_with_pw)) {
  strings <- test_names_with_pw[[i]] # Current list item

  # Extract values for each column
  existing_tests$yll_from_lifetable[i] <- str_extract(strings[str_detect(strings, "\\|yll_from_lifetable_")], "(?<=\\|yll_from_lifetable_)[^\\|]+")
  existing_tests$output_1_type[i] <- str_extract(strings[str_detect(strings, "\\|output_1_type_")], "(?<=\\|output_1_type_)[^\\|]+")
  existing_tests$output_2_type[i] <- str_extract(strings[str_detect(strings, "\\|output_2_type_")], "(?<=\\|output_2_type_)[^\\|]+")
  
  existing_tests$implemented[i] <- "TRUE"
}

## Merge the pathways tibble and the existing_tests tibble
pathways_daly <- pathways_daly %>%
  left_join(existing_tests, by = c("yll_from_lifetable", "output_1_type", "output_2_type"),
            suffix = c("", ".existing")) %>%
  mutate(implemented = coalesce(implemented.existing, implemented)) %>%
  select(-implemented.existing) |> 
  distinct() # Removes duplicate rows (rows that have the same pathway ID)

## Rearrange columns
pathways_daly <- pathways_daly |> 
  relocate(implemented) |> 
  relocate(core_pathway, .after = implemented) |> 
  arrange(desc(implemented), desc(core_pathway), desc(yll_from_lifetable), output_1_type, output_2_type)

# * Measure progress ###########################################################

## Create comparison current testing state overview
progress_daly <-
  tibble(
    domain = "DALY",
    n_implemented = nrow(pathways_daly |> filter(implemented == TRUE)),
    `%_of_core` = 
      paste0(
        round(
          pathways_daly |> filter(implemented== "TRUE") |> nrow() / 
            nrow(pathways_daly |> filter(core_pathway == "TRUE")) * 100, 
          digits = 0
        ),
        " %"),
    `%_of_total` = paste0(
        round(
          pathways_daly |> filter(implemented== "TRUE") |> nrow() / 
            nrow(pathways_daly) * 100, 
          digits = 0
        ),
        " %"),
    n_core_pw = nrow(pathways_daly |> filter(core_pathway == "TRUE")),
    n_all_pw = nrow(pathways_daly)
  )

## Output short report
cat("Number of DALY pathways implemented as tests:", progress_daly$n_implemented, "\n")
cat("% of core pathways:", progress_daly$`%_of_core`, "\n")
cat("% of all pathways:", progress_daly$`%_of_total`, "\n")
cat("Total number core of pathways:", progress_daly$n_core_pw, "\n")
cat("Total number of pathways:", progress_daly$n_all_pw, "\n")
```

# multiexposure

All pathways are core pathways

```{r Pathways multiexposure}

# * Define all relevant pathways ###############################################
## Create tibble containing (almost) all possible calculation pathways
pathways_multiexposure <- list(
  approach = c("additive", "multiplicative", "combined")
)

pathways_multiexposure <- expand.grid(pathways_multiexposure) |> 
  tibble::as_tibble() |>
  mutate_all(as.character) %>% # IMPORTANT TO USE magrittr PIPE
  ## Create all pathway ID's
  mutate(
    pathway_id = purrr::pmap_chr(., function(...) {
      vals <- list(...)
paste0("|pathway_multiexposure|", paste(names(vals), vals, sep = "_", collapse = "|"), "|")
})
  )
  
#* Define core pathways ########################################################
core_multiexposure <- list(
  approach = c("additive", "multiplicative", "combined")
)

core_multiexposure <- expand.grid(core_multiexposure) |> 
  tibble::as_tibble() |>
  mutate_all(as.character) |> 
  mutate(core_pathway = "TRUE")

pathways_multiexposure <- pathways_multiexposure |> 
  left_join(x = _, y = core_multiexposure, by = c("approach")) |> 
  mutate(core_pathway = ifelse(is.na(core_pathway), "FALSE", core_pathway)) |> 
  mutate(implemented = "FALSE")

# * Document existing pathways #################################################
file_path <- "../healthiar/tests/testthat/test-multiexpose.R"
file_content <- readLines(file_path) # String vector where each element is all code from a line

test_names <- regmatches(file_content, gregexpr('testthat::test_that\\("\\K[^"]+(?=", \\{)', file_content, perl = TRUE))
test_names_with_pw <- Filter(function(x) any(grepl("\\|pathway_multiexposure\\|", x)), test_names)

## Create an empty tibble with NA placeholders
n_row <- length(test_names_with_pw)
existing_tests <- tibble(
  approach = rep(NA_character_, n_row),
  implemented = rep("FALSE", n_row)
)

## Extract values and assign them directly to the tibble
for (i in seq_along(test_names_with_pw)) {
  strings <- test_names_with_pw[[i]] # Current list item

  # Extract values for each column
  existing_tests$approach[i] <- str_extract(strings[str_detect(strings, "\\|approach_")], "(?<=\\|approach_)[^\\|]+")
  
  existing_tests$implemented[i] <- "TRUE"
}

## Merge the pathways tibble and the existing_tests tibble
pathways_multiexposure <- pathways_multiexposure %>%
  left_join(existing_tests, by = c("approach"),
            suffix = c("", ".existing")) %>%
  mutate(implemented = coalesce(implemented.existing, implemented)) %>%
  select(-implemented.existing) |> 
  distinct() # Removes duplicate rows (rows that have the same pathway ID)

## Rearrange columns
pathways_multiexposure <- pathways_multiexposure |> 
  relocate(implemented) |> 
  relocate(core_pathway, .after = implemented) |> 
  arrange(desc(implemented), desc(core_pathway), approach)

# * Measure progress ###########################################################

## Create comparison current testing state overview
progress_multiexposure <-
  tibble(
    domain = "multiexposure",
    n_implemented = nrow(pathways_multiexposure |> filter(implemented == TRUE)),
    `%_of_core` = 
      paste0(
        round(
          pathways_multiexposure |> filter(implemented== "TRUE") |> nrow() / 
            nrow(pathways_multiexposure |> filter(core_pathway == "TRUE")) * 100, 
          digits = 0
        ),
        " %"),
    `%_of_total` = paste0(
        round(
          pathways_multiexposure |> filter(implemented== "TRUE") |> nrow() / 
            nrow(pathways_multiexposure) * 100, 
          digits = 0
        ),
        " %"),
    n_core_pw = nrow(pathways_multiexposure |> filter(core_pathway == "TRUE")),
    n_all_pw = nrow(pathways_multiexposure)
  )

## Output short report
cat("Number of multiexposure pathways implemented as tests:", progress_multiexposure$n_implemented, "\n")
cat("% of core pathways:", progress_multiexposure$`%_of_core`, "\n")
cat("% of all pathways:", progress_multiexposure$`%_of_total`, "\n")
cat("Total number core of pathways:", progress_multiexposure$n_core_pw, "\n")
cat("Total number of pathways:", progress_multiexposure$n_all_pw, "\n")
```

# life table

```{r Pathways lifetable}

pathways_lifetable <- list(
  exp = c("single", "dist"), # prop_pop_exp linked with this
  exp_time = c("single_year", "constant"),
  newborns = c("TRUE", "FALSE"),
  ## Note 2024-04-30 AL: in a later stage, maybe remove the min_age, max_age and time_horizon options ####
  min_age = c("TRUE", "FALSE"),
  max_age = c("TRUE", "FALSE"),
  time_horizon = c("TRUE", "FALSE"),
  iteration = c("TRUE", "FALSE")
)

pathways_lifetable <- expand.grid(pathways_lifetable) |> 
  tibble::as_tibble() |>
  mutate_all(as.character)

pathways_lifetable <- pathways_lifetable %>% # Important to use magrittr pipe
  mutate(
    pathway_id = purrr::pmap_chr(., function(...) {
      vals <- list(...)
      paste0("|pathway_lifetable|", paste(names(vals), vals, sep = "_", collapse = "|"), "|")
    })
  )

#* Define core pathways ########################################################
core_lifetable <- list(
  exp = c("single", "dist"),
  exp_time = c("single_year", "constant"),
  newborns = c("TRUE", "FALSE"),
  min_age = c("TRUE"),
  max_age = c("FALSE"),
  time_horizon = c("FALSE"),
  iteration = c("TRUE", "FALSE")
)

core_lifetable <- expand.grid(core_lifetable) |> 
  tibble::as_tibble() |>
  mutate_all(as.character) |> 
  mutate(core_pathway = "TRUE")

pathways_lifetable <- pathways_lifetable |> 
  left_join(x = _, y = core_lifetable, by = c("exp", "exp_time", "newborns", "min_age", "max_age", "time_horizon", "iteration")) |> 
  mutate(core_pathway = ifelse(is.na(core_pathway), "FALSE", core_pathway)) |> 
  mutate(implemented = "FALSE")

# * Document existing pathways ####

file_path <- "../healthiar/tests/testthat/test-attribute_lifetable.R"
file_content <- readLines(file_path) # String vector where each element is all code from a line

test_names <- regmatches(file_content, gregexpr('testthat::test_that\\("\\K[^"]+(?=", \\{)', file_content, perl = TRUE))
test_names_with_pw <- Filter(function(x) any(grepl("\\|pathway_lifetable\\|", x)), test_names)

## Create an empty tibble with NA placeholders
n_row <- length(test_names_with_pw)
existing_tests <- tibble(
  exp = rep(NA_character_, n_row),
  exp_time = rep(NA_character_, n_row),
  newborns = rep(NA_character_, n_row),
  min_age = rep(NA_character_, n_row),
  max_age = rep(NA_character_, n_row),
  time_horizon = rep(NA_character_, n_row),
  iteration = rep(NA_character_, n_row),
  implemented = rep("FALSE", n_row)
)

## Extract values and assign them directly to the tibble
for (i in seq_along(test_names_with_pw)) {
  strings <- test_names_with_pw[[i]] # Current list item

  # Extract values for each column
  existing_tests$exp[i] <- str_extract(strings[str_detect(strings, "\\|exp_")], "(?<=\\|exp_)[^\\|]+")
  existing_tests$exp_time[i] <- str_extract(strings[str_detect(strings, "\\|exp_time_")], "(?<=\\|exp_time_)[^\\|]+")
  existing_tests$newborns[i] <- str_extract(strings[str_detect(strings, "\\|newborns_")], "(?<=\\|newborns_)[^\\|]+")
  existing_tests$min_age[i] <- str_extract(strings[str_detect(strings, "\\|min_age_")], "(?<=\\|min_age_)[^\\|]+")
  existing_tests$max_age[i] <- str_extract(strings[str_detect(strings, "\\|max_age_")], "(?<=\\|max_age_)[^\\|]+")
  existing_tests$time_horizon[i] <- str_extract(strings[str_detect(strings, "\\|time_horizon_")], "(?<=\\|time_horizon_)[^\\|]+")
  existing_tests$iteration[i] <- str_extract(strings[str_detect(strings, "\\|iteration_")], "(?<=\\|iteration_)[^\\|]+")

  existing_tests$implemented[i] <- "TRUE"
}

## Merge the pathways tibble and the existing_tests tibble
pathways_lifetable <- pathways_lifetable %>%
  left_join(existing_tests, by = c("exp", "exp_time", "newborns", "min_age", "max_age", "time_horizon", "iteration"),
            suffix = c("", ".existing")) %>%
  mutate(implemented = coalesce(implemented.existing, implemented)) %>%
  select(-implemented.existing)|> 
  distinct() # Removes duplicate rows (rows that have the same pathway ID)

## Rearrange columns
pathways_lifetable <- pathways_lifetable |> 
  relocate(implemented) |> 
  relocate(core_pathway, .after = implemented) |> 
  arrange(desc(implemented), desc(core_pathway), desc(exp), desc(exp_time), newborns, desc(iteration))

# * Measure progress ###########################################################

## Create lifetable current testing state overview
progress_lifetable <-
  tibble(
    domain = "lifetable",
    n_implemented = nrow(pathways_lifetable |> filter(implemented == TRUE)),
    `%_of_core` = 
      paste0(
        round(
          pathways_lifetable |> filter(implemented== "TRUE") |> nrow() / 
            nrow(pathways_lifetable |> filter(core_pathway == "TRUE")) * 100, 
          digits = 0
        ),
        " %"),
    `%_of_total` = paste0(
        round(
          pathways_lifetable |> filter(implemented== "TRUE") |> nrow() / 
            nrow(pathways_lifetable) * 100, 
          digits = 0
        ),
        " %"),
    n_core_pw = nrow(pathways_lifetable |> filter(core_pathway == "TRUE")),
    n_all_pw = nrow(pathways_lifetable)
  )

## Output short report
cat("Number of lifetable pathways implemented as tests:", progress_lifetable$n_implemented, "\n")
cat("% of core pathways:", progress_lifetable$`%_of_core`, "\n")
cat("% of all pathways:", progress_lifetable$`%_of_total`, "\n")
cat("Total number core of pathways:", progress_lifetable$n_core_pw, "\n")
cat("Total number of pathways:", progress_lifetable$n_all_pw, "\n")
```


# socialize

```{r Pathways socialize}

ov_socialize <- list(
  input_is_attribute_output = c("TRUE", "FALSE"), # If FALSE: impact vector is the input
  social_indicator = c("TRUE", "FALSE"), # Either enter \code{social_indicator} and \code{n_quantile} or \code{social_quantile}
  ref_pop = c("TRUE", "FALSE") # ref_prop_pop
)

pathways_socialize <- expand.grid(ov_socialize) |> 
  tibble::as_tibble() |>
  mutate_all(as.character)

pathways_socialize <- pathways_socialize %>% # Important to use magrittr pipe
  mutate(
    pathway_id = purrr::pmap_chr(., function(...) {
      vals <- list(...)
      paste0("|pathway_socialize|", paste(names(vals), vals, sep = "_", collapse = "|"), "|")
    })
  ) 

#* Define core pathways ########################################################
core_socialize <- list(
  input_is_attribute_output = c("TRUE", "FALSE"),
  social_indicator = c("TRUE", "FALSE"), # Either enter \code{social_indicator} and \code{n_quantile} or \code{social_quantile}
  ref_pop = c("TRUE", "FALSE") # ref_prop_pop
)

core_socialize <- expand.grid(core_socialize) |> 
  tibble::as_tibble() |>
  mutate_all(as.character) |> 
  mutate(core_pathway = "TRUE")

pathways_socialize <- pathways_socialize |> 
  left_join(x = _, y = core_socialize, by = c("input_is_attribute_output", "social_indicator", "ref_pop")) |> 
  mutate(core_pathway = ifelse(is.na(core_pathway), "FALSE", core_pathway)) |> 
  mutate(implemented = "FALSE")

# * Document existing pathways ####

file_path <- "../healthiar/tests/testthat/test-socialize.R"
file_content <- readLines(file_path) # String vector where each element is all code from a line

test_names <- regmatches(file_content, gregexpr('testthat::test_that\\("\\K[^"]+(?=", \\{)', file_content, perl = TRUE))
test_names_with_pw <- Filter(function(x) any(grepl("\\|pathway_socialize\\|", x)), test_names)

## Create an empty tibble with NA placeholders
n_row <- length(test_names_with_pw)
existing_tests <- tibble(
  input_is_attribute_output = rep(NA_character_, n_row),
  social_indicator = rep(NA_character_, n_row),
  ref_pop = rep(NA_character_, n_row),
  implemented = rep("FALSE", n_row)
)

## Extract values and assign them directly to the tibble
for (i in seq_along(test_names_with_pw)) {
  strings <- test_names_with_pw[[i]] # Current list item

  # Extract values for each column
  existing_tests$input_is_attribute_output[i] <- str_extract(strings[str_detect(strings, "\\|input_is_attribute_output_")], "(?<=\\|input_is_attribute_output_)[^\\|]+")
  existing_tests$social_indicator[i] <- str_extract(strings[str_detect(strings, "\\|social_indicator_")], "(?<=\\|social_indicator_)[^\\|]+")
  existing_tests$ref_pop[i] <- str_extract(strings[str_detect(strings, "\\|ref_pop_")], "(?<=\\|ref_pop_)[^\\|]+")
  
  existing_tests$implemented[i] <- "TRUE"
}

## Merge the pathways tibble and the existing_tests tibble
pathways_socialize <- pathways_socialize %>%
  left_join(existing_tests, by = c("input_is_attribute_output", "social_indicator", "ref_pop"),
            suffix = c("", ".existing")) %>%
  mutate(implemented = coalesce(implemented.existing, implemented)) %>%
  select(-implemented.existing)|> 
  distinct() # Removes duplicate rows (rows that have the same pathway ID)

## Rearrange columns
pathways_socialize <- pathways_socialize |> 
  relocate(implemented) |> 
  relocate(core_pathway, .after = implemented) |> 
  arrange(desc(input_is_attribute_output), desc(social_indicator), desc(ref_pop))

# * Measure progress ###########################################################

## Create socialize current testing state overview
progress_socialize <-
  tibble(
    domain = "socialize",
    n_implemented = nrow(pathways_socialize |> filter(implemented == TRUE)),
    `%_of_core` = 
      paste0(
        round(
          pathways_socialize |> filter(implemented== "TRUE") |> nrow() / 
            nrow(pathways_socialize |> filter(core_pathway == "TRUE")) * 100, 
          digits = 0
        ),
        " %"),
    `%_of_total` = paste0(
        round(
          pathways_socialize |> filter(implemented== "TRUE") |> nrow() / 
            nrow(pathways_socialize) * 100, 
          digits = 0
        ),
        " %"),
    n_core_pw = nrow(pathways_socialize |> filter(core_pathway == "TRUE")),
    n_all_pw = nrow(pathways_socialize)
  )

## Output short report
cat("Number of socialize pathways implemented as tests:", progress_socialize$n_implemented, "\n")
cat("% of core pathways:", progress_socialize$`%_of_core`, "\n")
cat("% of all pathways:", progress_socialize$`%_of_total`, "\n")
cat("Total number core of pathways:", progress_socialize$n_core_pw, "\n")
cat("Total number of pathways:", progress_socialize$n_all_pw, "\n")
```

# Overall progress 

```{r}

## Non-liftable overall progress
progress_overall_non_lifetable <- rbind(
  progress_rr,
  progress_ar,
  progress_uncertainty,
  progress_compare,
  progress_monetization,
  progress_cba,
  progress_daly,
  progress_multiexposure
)

overall_row_non_lifetable <- tibble(
  domain = "OVERALL",
  n_implemented = sum(progress_overall_non_lifetable$n_implemented),
  `%_of_core` = paste0(
    round(
      sum(progress_overall_non_lifetable$n_implemented) / 
        sum(progress_overall_non_lifetable$n_core_pw) * 100
    ),
    " %"
  ),
  `%_of_total` = paste0(
    round(
      sum(progress_overall_non_lifetable$n_implemented) / 
        sum(progress_overall_non_lifetable$n_all_pw) * 100
    ),
    " %"
  ),
  n_core_pw = sum(progress_overall_non_lifetable$n_core_pw),
  n_all_pw = sum(progress_overall_non_lifetable$n_all_pw)
) 

empty_row <- tibble(
  domain = NA_character_,
  n_implemented = NA_integer_,
  `%_of_core` = NA_character_,
  `%_of_total` = NA_character_,
  n_core_pw = NA_integer_,
  n_all_pw = NA_integer_
)  

## Lifetable overall progress
overall_row_lifetable <- tibble(
  domain = "OVERALL (lifetable pathways)",
  n_implemented = sum(progress_lifetable$n_implemented),
  `%_of_core` = paste0(
    round(
      sum(progress_lifetable$n_implemented) / 
        sum(progress_lifetable$n_core_pw) * 100
    ),
    " %"
  ),
  `%_of_total` = paste0(
    round(
      sum(progress_lifetable$n_implemented) / 
        sum(progress_lifetable$n_all_pw) * 100
    ),
    " %"
  ),
  n_core_pw = sum(progress_lifetable$n_core_pw),
  n_all_pw = sum(progress_lifetable$n_all_pw)
)  

# Overall progress (both non-lifetable and lifetable pathways)
progress_overall <- rbind(overall_row_non_lifetable, progress_overall_non_lifetable, empty_row, overall_row_lifetable, progress_lifetable)
```


# Create Excel
                                                                     
```{r Create Excel with all pathways for Teams folder}
knitr::opts_knit$set(root.dir = getwd())

pathways_rr <- pathways_rr |> 
  mutate(`     ` = NA_character_) |> # Empty column to improve overview
  mutate(institute_1 = NA_character_) |> 
  mutate(name_1 = NA_character_) |> 
  mutate(finished_1 = "FALSE") |> 
  mutate(results_the_same_1 = NA_character_) |> 
  mutate(comment_1 = NA_character_) |> 
  mutate(`      ` = NA_character_) |> # Empty column to improve overview
  mutate(institute_2 = NA_character_) |> 
  mutate(name_2 = NA_character_) |> 
  mutate(finished_2 = "FALSE") |> 
  mutate(results_the_same_2 = NA_character_) |> 
  mutate(comment_2 = NA_character_) |> 
  mutate(`       ` = NA_character_) |> # Empty column to improve overview
  mutate(institute_3 = NA_character_) |> 
  mutate(name_3 = NA_character_) |> 
  mutate(finished_3 = "FALSE") |> 
  mutate(results_the_same_3 = NA_character_) |> 
  mutate(comment_3 = NA_character_) |> 
  mutate(`        ` = NA_character_) |> # Empty column to improve overview
  mutate(institute_4 = NA_character_) |> 
  mutate(name_4 = NA_character_) |> 
  mutate(finished_4 = "FALSE") |> 
  mutate(results_the_same_4 = NA_character_) |> 
  mutate(comment_4 = NA_character_) |> 
  mutate(`         ` = NA_character_) |> # Empty column to improve overview
  mutate(institute_5 = NA_character_) |> 
  mutate(name_5 = NA_character_) |> 
  mutate(finished_5 = "FALSE") |> 
  mutate(results_the_same_5 = NA_character_) |> 
  mutate(comment_5 = NA_character_)
  
pathways_ar <- pathways_ar |> 
  mutate(`     ` = NA_character_) |> # Empty column to improve overview
  mutate(institute_1 = NA_character_) |> 
  mutate(name_1 = NA_character_) |> 
  mutate(finished_1 = "FALSE") |> 
  mutate(results_the_same_1 = NA_character_) |> 
  mutate(comment_1 = NA_character_) |> 
  mutate(`      ` = NA_character_) |> # Empty column to improve overview
  mutate(institute_2 = NA_character_) |> 
  mutate(name_2 = NA_character_) |> 
  mutate(finished_2 = "FALSE") |> 
  mutate(results_the_same_2 = NA_character_) |> 
  mutate(comment_2 = NA_character_) |> 
  mutate(`       ` = NA_character_) |> # Empty column to improve overview
  mutate(institute_3 = NA_character_) |> 
  mutate(name_3 = NA_character_) |> 
  mutate(finished_3 = "FALSE") |> 
  mutate(results_the_same_3 = NA_character_) |> 
  mutate(comment_3 = NA_character_) |> 
  mutate(`        ` = NA_character_) |> # Empty column to improve overview
  mutate(institute_4 = NA_character_) |> 
  mutate(name_4 = NA_character_) |> 
  mutate(finished_4 = "FALSE") |> 
  mutate(results_the_same_4 = NA_character_) |> 
  mutate(comment_4 = NA_character_) |> 
  mutate(`         ` = NA_character_) |> # Empty column to improve overview
  mutate(institute_5 = NA_character_) |> 
  mutate(name_5 = NA_character_) |> 
  mutate(finished_5 = "FALSE") |> 
  mutate(results_the_same_5 = NA_character_) |> 
  mutate(comment_5 = NA_character_)


pathways_uncertainty <- pathways_uncertainty |> 
  mutate(`     ` = NA_character_) |> # Empty column to improve overview
  mutate(institute_1 = NA_character_) |> 
  mutate(name_1 = NA_character_) |> 
  mutate(finished_1 = "FALSE") |> 
  mutate(results_the_same_1 = NA_character_) |> 
  mutate(comment_1 = NA_character_)|> 
  mutate(`      ` = NA_character_) |> # Empty column to improve overview
  mutate(institute_2 = NA_character_) |> 
  mutate(name_2 = NA_character_) |> 
  mutate(finished_2 = "FALSE") |> 
  mutate(results_the_same_2 = NA_character_) |> 
  mutate(comment_2 = NA_character_) |> 
  mutate(`       ` = NA_character_) |> # Empty column to improve overview
  mutate(institute_3 = NA_character_) |> 
  mutate(name_3 = NA_character_) |> 
  mutate(finished_3 = "FALSE") |> 
  mutate(results_the_same_3 = NA_character_) |> 
  mutate(comment_3 = NA_character_) |> 
  mutate(`        ` = NA_character_) |> # Empty column to improve overview
  mutate(institute_4 = NA_character_) |> 
  mutate(name_4 = NA_character_) |> 
  mutate(finished_4 = "FALSE") |> 
  mutate(results_the_same_4 = NA_character_) |> 
  mutate(comment_4 = NA_character_) |> 
  mutate(`         ` = NA_character_) |> # Empty column to improve overview
  mutate(institute_5 = NA_character_) |> 
  mutate(name_5 = NA_character_) |> 
  mutate(finished_5 = "FALSE") |> 
  mutate(results_the_same_5 = NA_character_) |> 
  mutate(comment_5 = NA_character_)


pathways_compare <- pathways_compare |> 
  mutate(`     ` = NA_character_) |> # Empty column to improve overview
  mutate(institute_1 = NA_character_) |> 
  mutate(name_1 = NA_character_) |> 
  mutate(finished_1 = "FALSE") |> 
  mutate(results_the_same_1 = NA_character_) |> 
  mutate(comment_1 = NA_character_) |> 
  mutate(`      ` = NA_character_) |> # Empty column to improve overview
  mutate(institute_2 = NA_character_) |> 
  mutate(name_2 = NA_character_) |> 
  mutate(finished_2 = "FALSE") |> 
  mutate(results_the_same_2 = NA_character_) |> 
  mutate(comment_2 = NA_character_) |> 
  mutate(`       ` = NA_character_) |> # Empty column to improve overview
  mutate(institute_3 = NA_character_) |> 
  mutate(name_3 = NA_character_) |> 
  mutate(finished_3 = "FALSE") |> 
  mutate(results_the_same_3 = NA_character_) |> 
  mutate(comment_3 = NA_character_) |> 
  mutate(`        ` = NA_character_) |> # Empty column to improve overview
  mutate(institute_4 = NA_character_) |> 
  mutate(name_4 = NA_character_) |> 
  mutate(finished_4 = "FALSE") |> 
  mutate(results_the_same_4 = NA_character_) |> 
  mutate(comment_4 = NA_character_) |> 
  mutate(`         ` = NA_character_) |> # Empty column to improve overview
  mutate(institute_5 = NA_character_) |> 
  mutate(name_5 = NA_character_) |> 
  mutate(finished_5 = "FALSE") |> 
  mutate(results_the_same_5 = NA_character_) |> 
  mutate(comment_5 = NA_character_)

pathways_monetization <- pathways_monetization |> 
  mutate(`     ` = NA_character_) |> # Empty column to improve overview
  mutate(institute_1 = NA_character_) |> 
  mutate(name_1 = NA_character_) |> 
  mutate(finished_1 = "FALSE") |> 
  mutate(results_the_same_1 = NA_character_) |> 
  mutate(comment_1 = NA_character_) |> 
  mutate(`      ` = NA_character_) |> # Empty column to improve overview
  mutate(institute_2 = NA_character_) |> 
  mutate(name_2 = NA_character_) |> 
  mutate(finished_2 = "FALSE") |> 
  mutate(results_the_same_2 = NA_character_) |> 
  mutate(comment_2 = NA_character_) |> 
  mutate(`       ` = NA_character_) |> # Empty column to improve overview
  mutate(institute_3 = NA_character_) |> 
  mutate(name_3 = NA_character_) |> 
  mutate(finished_3 = "FALSE") |> 
  mutate(results_the_same_3 = NA_character_) |> 
  mutate(comment_3 = NA_character_) |> 
  mutate(`        ` = NA_character_) |> # Empty column to improve overview
  mutate(institute_4 = NA_character_) |> 
  mutate(name_4 = NA_character_) |> 
  mutate(finished_4 = "FALSE") |> 
  mutate(results_the_same_4 = NA_character_) |> 
  mutate(comment_4 = NA_character_) |> 
  mutate(`         ` = NA_character_) |> # Empty column to improve overview
  mutate(institute_5 = NA_character_) |> 
  mutate(name_5 = NA_character_) |> 
  mutate(finished_5 = "FALSE") |> 
  mutate(results_the_same_5 = NA_character_) |> 
  mutate(comment_5 = NA_character_)


pathways_cba <- pathways_cba |> 
  mutate(`     ` = NA_character_) |> # Empty column to improve overview
  mutate(institute_1 = NA_character_) |> 
  mutate(name_1 = NA_character_) |> 
  mutate(finished_1 = "FALSE") |> 
  mutate(results_the_same_1 = NA_character_) |> 
  mutate(comment_1 = NA_character_)|> 
  mutate(`      ` = NA_character_) |> # Empty column to improve overview
  mutate(institute_2 = NA_character_) |> 
  mutate(name_2 = NA_character_) |> 
  mutate(finished_2 = "FALSE") |> 
  mutate(results_the_same_2 = NA_character_) |> 
  mutate(comment_2 = NA_character_) |> 
  mutate(`       ` = NA_character_) |> # Empty column to improve overview
  mutate(institute_3 = NA_character_) |> 
  mutate(name_3 = NA_character_) |> 
  mutate(finished_3 = "FALSE") |> 
  mutate(results_the_same_3 = NA_character_) |> 
  mutate(comment_3 = NA_character_) |> 
  mutate(`        ` = NA_character_) |> # Empty column to improve overview
  mutate(institute_4 = NA_character_) |> 
  mutate(name_4 = NA_character_) |> 
  mutate(finished_4 = "FALSE") |> 
  mutate(results_the_same_4 = NA_character_) |> 
  mutate(comment_4 = NA_character_) |> 
  mutate(`         ` = NA_character_) |> # Empty column to improve overview
  mutate(institute_5 = NA_character_) |> 
  mutate(name_5 = NA_character_) |> 
  mutate(finished_5 = "FALSE") |> 
  mutate(results_the_same_5 = NA_character_) |> 
  mutate(comment_5 = NA_character_)

pathways_daly <- pathways_daly |> 
  mutate(`     ` = NA_character_) |> # Empty column to improve overview
  mutate(institute_1 = NA_character_) |> 
  mutate(name_1 = NA_character_) |> 
  mutate(finished_1 = "FALSE") |> 
  mutate(results_the_same_1 = NA_character_) |> 
  mutate(comment_1 = NA_character_) |> 
  mutate(`      ` = NA_character_) |> # Empty column to improve overview
  mutate(institute_2 = NA_character_) |> 
  mutate(name_2 = NA_character_) |> 
  mutate(finished_2 = "FALSE") |> 
  mutate(results_the_same_2 = NA_character_) |> 
  mutate(comment_2 = NA_character_) |> 
  mutate(`       ` = NA_character_) |> # Empty column to improve overview
  mutate(institute_3 = NA_character_) |> 
  mutate(name_3 = NA_character_) |> 
  mutate(finished_3 = "FALSE") |> 
  mutate(results_the_same_3 = NA_character_) |> 
  mutate(comment_3 = NA_character_) |> 
  mutate(`        ` = NA_character_) |> # Empty column to improve overview
  mutate(institute_4 = NA_character_) |> 
  mutate(name_4 = NA_character_) |> 
  mutate(finished_4 = "FALSE") |> 
  mutate(results_the_same_4 = NA_character_) |> 
  mutate(comment_4 = NA_character_) |> 
  mutate(`         ` = NA_character_) |> # Empty column to improve overview
  mutate(institute_5 = NA_character_) |> 
  mutate(name_5 = NA_character_) |> 
  mutate(finished_5 = "FALSE") |> 
  mutate(results_the_same_5 = NA_character_) |> 
  mutate(comment_5 = NA_character_)

pathways_multiexposure <- pathways_multiexposure |> 
  mutate(`     ` = NA_character_) |> # Empty column to improve overview
  mutate(institute_1 = NA_character_) |> 
  mutate(name_1 = NA_character_) |> 
  mutate(finished_1 = "FALSE") |> 
  mutate(results_the_same_1 = NA_character_) |> 
  mutate(comment_1 = NA_character_) |> 
  mutate(`      ` = NA_character_) |> # Empty column to improve overview
  mutate(institute_2 = NA_character_) |> 
  mutate(name_2 = NA_character_) |> 
  mutate(finished_2 = "FALSE") |> 
  mutate(results_the_same_2 = NA_character_) |> 
  mutate(comment_2 = NA_character_) |> 
  mutate(`       ` = NA_character_) |> # Empty column to improve overview
  mutate(institute_3 = NA_character_) |> 
  mutate(name_3 = NA_character_) |> 
  mutate(finished_3 = "FALSE") |> 
  mutate(results_the_same_3 = NA_character_) |> 
  mutate(comment_3 = NA_character_) |> 
  mutate(`        ` = NA_character_) |> # Empty column to improve overview
  mutate(institute_4 = NA_character_) |> 
  mutate(name_4 = NA_character_) |> 
  mutate(finished_4 = "FALSE") |> 
  mutate(results_the_same_4 = NA_character_) |> 
  mutate(comment_4 = NA_character_) |> 
  mutate(`         ` = NA_character_) |> # Empty column to improve overview
  mutate(institute_5 = NA_character_) |> 
  mutate(name_5 = NA_character_) |> 
  mutate(finished_5 = "FALSE") |> 
  mutate(results_the_same_5 = NA_character_) |> 
  mutate(comment_5 = NA_character_)

pathways_lifetable <- pathways_lifetable |> 
  mutate(`     ` = NA_character_) |> # Empty column to improve overview
  mutate(institute_1 = NA_character_) |> 
  mutate(name_1 = NA_character_) |> 
  mutate(finished_1 = "FALSE") |> 
  mutate(results_the_same_1 = NA_character_) |> 
  mutate(comment_1 = NA_character_) |> 
  mutate(`      ` = NA_character_) |> # Empty column to improve overview
  mutate(institute_2 = NA_character_) |> 
  mutate(name_2 = NA_character_) |> 
  mutate(finished_2 = "FALSE") |> 
  mutate(results_the_same_2 = NA_character_) |> 
  mutate(comment_2 = NA_character_) |> 
  mutate(`       ` = NA_character_) |> # Empty column to improve overview
  mutate(institute_3 = NA_character_) |> 
  mutate(name_3 = NA_character_) |> 
  mutate(finished_3 = "FALSE") |> 
  mutate(results_the_same_3 = NA_character_) |> 
  mutate(comment_3 = NA_character_) |> 
  mutate(`        ` = NA_character_) |> # Empty column to improve overview
  mutate(institute_4 = NA_character_) |> 
  mutate(name_4 = NA_character_) |> 
  mutate(finished_4 = "FALSE") |> 
  mutate(results_the_same_4 = NA_character_) |> 
  mutate(comment_4 = NA_character_) |> 
  mutate(`         ` = NA_character_) |> # Empty column to improve overview
  mutate(institute_5 = NA_character_) |> 
  mutate(name_5 = NA_character_) |> 
  mutate(finished_5 = "FALSE") |> 
  mutate(results_the_same_5 = NA_character_) |> 
  mutate(comment_5 = NA_character_)

pathways_list <- list(
  progress_overall,
  pathways_rr,
  pathways_ar,
  pathways_uncertainty,
  pathways_compare,
  pathways_monetization,
  pathways_cba,
  pathways_daly,
  pathways_multiexposure,
  pathways_lifetable
)
names(pathways_list) <- c("OVERALL", "RR", "AR", "summary uncertainty", "comparison", "monetization", "CBA", "DALY", "multiexposure", "lifetable")

hs <- openxlsx::createStyle(textDecoration = "bold") # hs = header style

openxlsx::write.xlsx(pathways_list, "tests/overview_testing.xlsx",
                     headerStyle = hs,
                     gridExpand = TRUE) # doesn't seem to have effect

```
