---
title: "Testing of BEST-COST R package"
author: "Alberto Castro & Axel Luyten"
output: html_document
---
# Goal
Test the functions of the bestcost package comparing the results with results from other tools or assessments


# Load packages and data


The R script required the loading of certain R packages. 
```{r Load packages, include=FALSE}
# Load required packages

# to assess performance
library(profvis)
library(bench)
library(microbenchmark)

# to manipulate data
library(readxl)
library(dplyr)
library(tidyr)
library(purrr)
library(stringr)
library(tibble)
library(zoo)

# to set colors in console messages (checking)
library(crayon)

# to visualize results
library(ggplot2)

## to export tables in excel format
library(openxlsx)

## to load own packages
library(credentials)
library(gitcreds)
library(devtools)


```


```{r load bestcost package}
# Load package (either current version or installed version)
devtools::load_all(export_all = FALSE)
library(bestcost)
```


```{r Alternative 1 to load bestcost: Install own package from github, eval=FALSE, include=FALSE}
# Install own package from github as suggested here: https://stackoverflow.com/a/71846333/6104907
if(!"bestcost" %in% installed.packages()[, "Package"]){
  #gitcreds::gitcreds_set()
  #usethis::use_git_config(user.name = "YourName", user.email = "your@mail.com") # run if installation doesn't work
  credentials::set_github_pat() # paste github PAT if prompted
  devtools::install_github(repo = "best-cost/best-cost_WPs",
                           subdir = "/r_package/bestcost",
                           ref = "HEAD", # Branch name (by default "HEAD") as a string
                           force = TRUE)
}
library(bestcost)
```



```{r Alternative 2 to load bestcost: load zip from local source, eval=FALSE, include=FALSE}
detach("package:bestcost", unload = TRUE) # detach bestcost
devtools::build(binary = TRUE, path = "../testing/input/") # Save current state of package as .zip file (e.g. to directly test changes in functions)
install.packages("../testing/input/bestcost_0.0.0.1.zip", repos=NULL, type='source') # Install package from source
library(bestcost)
```


Load the Rdata file that contains all variables needed to run this script.
```{r load data }
load("../testing/input/data/input_data_for_testing_Rpackage.RData")
```



# Calculate health impacts

## Attributable health impact

### Single baseline health data

```{r single exposure value}

# Assess attributable cases using the AirQ+ export as input data
bestcost_pm_copd <-
  bestcost::attribute_health_singlebhd_rr(
    exp = airqplus_pm_copd$mean_concentration,
    cutoff = airqplus_pm_copd$cut_off_value,   
    bhd = airqplus_pm_copd$incidents_per_100_000_per_year/1E5*airqplus_pm_copd$population_at_risk,
    rr = c(airqplus_pm_copd$relative_risk, airqplus_pm_copd$relative_risk_lower, airqplus_pm_copd$relative_risk_upper),
    rr_increment = 10, 
    erf_shape = "log_linear", 
    info = paste0(airqplus_pm_copd$pollutant,"_", airqplus_pm_copd$evaluation_name))

# Store the central, lower and upper estimate of the AirQ+ assessment
airqplus_pm_copd_result <- 
  airqplus_pm_copd %>%
  dplyr::select(estimated_number_of_attributable_cases_central,
                estimated_number_of_attributable_cases_lower,
                estimated_number_of_attributable_cases_upper)%>%
  unlist()


check_bestcost(result_list_bestcost = bestcost_pm_copd,
               result_vector_alternative = airqplus_pm_copd_result)


```


```{r single exposure value and relative risk}

# Assess attributable cases using the AirQ+ export as input data
att_pm_copd_1rr_bestcost <-
  bestcost::attribute_health_singlebhd_rr(
    exp = airqplus_pm_copd$mean_concentration,
    cutoff = airqplus_pm_copd$cut_off_value,   
    bhd = airqplus_pm_copd$incidents_per_100_000_per_year/1E5*airqplus_pm_copd$population_at_risk,
    rr = airqplus_pm_copd$relative_risk,
    rr_increment = 10, 
    erf_shape = "log_linear", 
    info = paste0(airqplus_pm_copd$pollutant,"_", airqplus_pm_copd$evaluation_name))

# Store the central, lower and upper estimate of the AirQ+ assessment
att_pm_copd_1rr_airqplus_result <- 
  airqplus_pm_copd %>%
  dplyr::select(estimated_number_of_attributable_cases_central)%>%
  unlist()


check_bestcost(result_list_bestcost = bestcost_pm_copd,
               result_vector_alternative = airqplus_pm_copd_result)


```


```{r exposure distribution}

# Extract rows that contain input data (others may contain results)
niph_noise_ihd_input <- 
  niph_noise_ihd_excel %>%
  dplyr::filter(!is.na(niph_noise_ihd_excel$exposure_mean))

# Extract results from excel table
# Only one (central) value for ERF, 
# so let's repeat the value three times to build 
# the vector for lower and upper bound
niph_noise_ihd_result <- 
  rep(niph_noise_ihd_excel %>%
        dplyr::filter(exposure_category %in% "Total exposed")%>%
        dplyr::select(daly)%>%
        dplyr::pull(), 
      3) %>%
  round()

# Obtain attributable cases using the bestcost package and input data from niph
bestcost_noise_ihd_expDist <- 
  bestcost::attribute_health_singlebhd_rr(
    exp = niph_noise_ihd_input$exposure_mean,
    prop_pop_exp = niph_noise_ihd_input$prop_exposed,
    cutoff = min(niph_noise_ihd_input$exposure_mean), 
    bhd = niph_noise_ihd_input$gbd_daly[1],
    rr = rep(1.08, 3),
    rr_increment = 10, 
    erf_shape = "log_linear",
    info = data.frame(pollutant = "road_noise", outcome = "YLD"))


check_bestcost(result_list_bestcost = bestcost_noise_ihd_expDist,
               result_vector_alternative = niph_noise_ihd_result)
                                               

```


```{r absolute risk}

# Extract rows that contain input data (others may contain results)
niph_noise_ha_input <- 
  niph_noise_ha_excel %>%
  dplyr::filter(!is.na(niph_noise_ha_excel$exposure_mean))

# Extract results from excel table
# Only one (central) value for ERF, 
# so let's repeat the value three times to build 
# the vector for lower and upper bound
niph_noise_ha_result <- 
  rep(niph_noise_ha_excel %>%
        dplyr::filter(exposure_category %in% "Total exposed")%>%
        dplyr::select(number)%>%
        dplyr::pull(), 
      3) %>%
  round()

# Obtain attributable cases using the bestcost package and input data from niph
bestcost_noise_ha_ar <- 
  bestcost::attribute_health_singlebhd_ar(
    exp = niph_noise_ha_input$exposure_mean,
    pop_exp = niph_noise_ha_input$population_exposed_total, 
    erf_c = rep("78.9270-3.1162*c+0.0342*c^2", 3),
    info = data.frame(pollutant = "road_noise", outcome = "highly_annoyance"))

check_bestcost(result_list_bestcost = bestcost_noise_ha_ar,
               result_vector_alternative = niph_noise_ha_result)


```



### Life table

```{r Probability of dying}

# Remove years over 40 
# because we are going to compare with results up to 39 years old
airqplus_prob_dying_age0to39_multipleYear <- 
  airqplus_deaths_pop_multipleYear%>%
  dplyr::filter(To<40)

# Results from the AirQ+ manual (to be compared with bestcost results)
airqplus_prob_dying_age0to39_singleYear <-
  airqplus_deaths_pop_singleYear%>%
  dplyr::filter(To<40)

# Use bestcost function
bestcost_prob_dying <- 
  bestcost::get_prob_dying_by_single_age(
    first_age_pop = first(airqplus_prob_dying_age0to39_multipleYear$From),
    last_age_pop = last(airqplus_prob_dying_age0to39_multipleYear$To),
    interval_age_pop = first(airqplus_prob_dying_age0to39_multipleYear$To) - first(airqplus_prob_dying_age0to39_multipleYear$From)+1,
    population_midyear = airqplus_prob_dying_age0to39_multipleYear$mi,
    deaths = airqplus_prob_dying_age0to39_multipleYear$di,
    fraction_of_year_lived = 0.5
  )


 # Compare and show message with colors
  if(all((bestcost_prob_dying$prob_dying - 
          as.numeric(airqplus_prob_dying_age0to39_singleYear$qx)) < 0.002)){
    cat(paste(crayon::cyan("Right. Bestcost and alternative source with similar results.")))
  } else{
    cat(paste(crayon::red("Attention! Check! Bestcost and alternative source with very different results.")))}
```

```{r premature deaths with lifetable}
#TODO
# First obtain probability of dying
# (AirQ+ does not use probability of dying as input data but bestcost does)
prob_dying <- 
  list(
    natural_male = bestcost::get_prob_dying_by_single_age(
      first_age_pop = first(airqplus_pm_deaths_yll[["pop"]]$age_from...),
      last_age_pop = last(airqplus_pm_deaths_yll[["pop"]]$age_from...),
      interval_age_pop =first(airqplus_pm_deaths_yll[["pop"]]$age_from...) - first(airqplus_pm_deaths_yll[["pop"]]$age_from...)+1,
      population_midyear = airqplus_prob_dying_age0to39_multipleYear$mi,
      deaths = airqplus_prob_dying_age0to39_multipleYear$di),
    natural_female = ,
    total_male = ,
    total_female = 
  )
  

# Calculate premature deaths using bestcost function

bestcost_pm_deaths_lifetable <-
  bestcost::attribute_deaths_lifetable_rr(
    exp = airqplus_pm_deaths_yll[["input"]]$mean_concentration, 
    cutoff = airqplus_pm_deaths_yll[["input"]]$cut_off_value,
    rr = airqplus_pm_deaths_yll[["input"]][, c("relative_risk",
                                               "relative_risk_lower",
                                               "relative_risk_upper")],
    rr_increment = 10, 
    erf_shape = gsub("-", "_", airqplus_pm_deaths_yll[["input"]]$calculation_method),
    first_age_pop = first(airqplus_pm_deaths_yll[["pop"]]$age_from...),
    last_age_pop = last(airqplus_pm_deaths_yll[["pop"]]$age_from...),
    #TODO
    prob_natural_death_male = airqplus_pm_deaths_yll[["pop"]]$,
    prob_natural_death_female = airqplus_pm_deaths_yll[["pop"]]$,
    prob_total_death_male = airqplus_pm_deaths_yll[["pop"]]$,
    prob_total_death_female = airqplus_pm_deaths_yll[["pop"]]$,
    population_midyear_male = airqplus_pm_deaths_yll[["pop"]]$midyear_population_male,
    population_midyear_female = airqplus_pm_deaths_yll[["pop"]]$midyear_population_female, 
    year_of_analysis =  airqplus_pm_deaths_yll[["input"]]$start_year, 
    min_age = airqplus_pm_deaths_yll[["input"]]$apply_rr_from_age)





impact_mortality_raw <- list()
#for(i in 1:nrow(input_data_mortality)){  # Use this if you want to evaluate multiple RRs
for(i in 2){                           # Use this if you want to evaluate only one RRs
  impact_mortality_raw[[input_data_mortality$year[i]]][[input_data_mortality$rr_id[[i]]]] <-
  
    bestcost::attribute_deaths_lifetable_rr(

    exp = input_data_mortality$exp[i], # PM2.5=8.30=limit LRV CH, NO2=16.32=mean conc. in CH in 2019
    cutoff = input_data_mortality$cutoff[i],   # PM2.5=5, NO2=10, i.e. WHO AQG 2021 
    rr = unlist(input_data_mortality[i,
                                      c("rr_central", "rr_lower", "rr_upper")]),
    rr_increment = 10, 
    erf_shape = "log_linear",
    first_age_pop = 0,
    last_age_pop = 99,
    prob_natural_death_male = lifetable_withPopulation[["male"]]$death_probability_natural,
    prob_natural_death_female = lifetable_withPopulation[["female"]]$death_probability_natural,
    prob_total_death_male = lifetable_withPopulation[["male"]]$death_probability_total,
    prob_total_death_female = lifetable_withPopulation[["female"]]$death_probability_total,
    population_midyear_male = lifetable_withPopulation[["male"]]$population, 
    population_midyear_female = lifetable_withPopulation[["female"]]$population, 
    year_of_analysis = 2019, 
    info = input_data_mortality$pollutant[i], 
    min_age = input_data_mortality$min_age[i],
    max_age = 99)
    #max_age = input_data_mortality$max_age[i])
}

head(impact_mortality_raw[["2019"]][["PM2.5_premature deaths_all causes_adults_main_ERS-ISEE_2022_selected"]][["total"]]$impact)


```

```{r mortality using exposure distribution}


# Calculate premature deaths using bestcost function




impact_deaths_expDistribution_raw <- list()

# Calculate premature deaths using bestcost function

#for(i in 1:nrow(input_data_mortality)){  # Use this if you want to evaluate multiple RRs
for(i in 2){                           # Use this if you want to evaluate only one RR
  impact_deaths_expDistribution_raw[[input_data_mortality$year[i]]][[input_data_mortality$rr_id[[i]]]] <-
    
    bestcost::attribute_deaths_lifetable_rr(
      exp = c(8, 9, 10), # Fake data just for testing purposes
      prop_pop_exp = c(0.2, 0.3, 0.5), # Fake data just for testing purposes
      cutoff = input_data_mortality$cutoff[i],   # PM2.5=5, NO2=10, i.e. WHO AQG 2021 
      rr = unlist(input_data_mortality[i,
                                        c("rr_central", "rr_lower", "rr_upper")]),
      rr_increment = 10, 
      erf_shape = "log_linear",
      first_age_pop = 0,
      last_age_pop = 99,
      prob_natural_death_male = lifetable_withPopulation[["male"]]$death_probability_natural,
      prob_natural_death_female = lifetable_withPopulation[["female"]]$death_probability_natural,
      prob_total_death_male = lifetable_withPopulation[["male"]]$death_probability_total,
      prob_total_death_female = lifetable_withPopulation[["female"]]$death_probability_total,
      population_midyear_male = lifetable_withPopulation[["male"]]$population, 
      population_midyear_female = lifetable_withPopulation[["female"]]$population, 
      year_of_analysis = 2019, 
      info = input_data_mortality$pollutant[i], 
      min_age = if(is.na(input_data_mortality$min_age[i])) NULL else input_data_mortality$min_age[i],
      max_age = 99)
      # max_age = if(is.na(input_data_mortality$max_age[i])) NULL else input_data_mortality$max_age[i])

}

head(impact_deaths_expDistribution_raw$`2019`$`PM2.5_premature deaths_all causes_adults_main_ERS-ISEE_2022_selected`$total$impact) # to check results stay the same
#4250 1537 2911


impact_yll_expDistribution_raw <- list()

# Calculate mortality impacts using bestcost function

#for(i in 1:nrow(input_data_mortality)){  # Use this if you want to evaluate multiple RRs
for(i in 2){                           # Use this if you want to evaluate only one RR
  impact_yll_expDistribution_raw[[input_data_mortality$year[i]]][[input_data_mortality$rr_id[[i]]]] <-
    
    bestcost::attribute_yll_lifetable_rr(
      exp = c(8, 9, 10), # Fake data just for testing purposes
      prop_pop_exp = c(0.2, 0.3, 0.5), # Fake data just for testing purposes
      cutoff = input_data_mortality$cutoff[i], # WHO AQG 2021 
      rr = unlist(input_data_mortality[i, c("rr_central", "rr_lower", "rr_upper")]),
      rr_increment = 10, 
      erf_shape = "log_linear",
      first_age_pop = 0,
      last_age_pop = 99,
      prob_natural_death_male = lifetable_withPopulation[["male"]]$death_probability_natural,
      prob_natural_death_female = lifetable_withPopulation[["female"]]$death_probability_natural,
      prob_total_death_male = lifetable_withPopulation[["male"]]$death_probability_total,
      prob_total_death_female = lifetable_withPopulation[["female"]]$death_probability_total,
      population_midyear_male = lifetable_withPopulation[["male"]]$population, 
      population_midyear_female = lifetable_withPopulation[["female"]]$population, 
      year_of_analysis = 2019, 
      info = input_data_mortality$pollutant[i], 
      min_age = if(is.na(input_data_mortality$min_age[i])) NULL else input_data_mortality$min_age[i],
      max_age = 99)
      #max_age = if(is.na(input_data_mortality$max_age[i])) NULL else input_data_mortality$max_age[i])
}
head(impact_yll_expDistribution_raw$`2019`$`PM2.5_premature deaths_all causes_adults_main_ERS-ISEE_2022_selected`$total$impact) 

```



```{r yll lifetable}
impact_yll_expDistribution <- list()
impact_yll_expDistribution[[input_data_mortality$year[2]]][[input_data_mortality$rr_id[[2]]]] <-
    bestcost::attribute_yll_lifetable_rr(
      exp = input_data_mortality$exp[2],
      # exp = c(8, 9, 10), # Fake data just for testing purposes
      prop_pop_exp = 1,
      # prop_pop_exp = c(0.2, 0.3, 0.5), # Fake data just for testing purposes
      cutoff = input_data_mortality$cutoff[2], # WHO AQG 2021 
      rr = unlist(input_data_mortality[2, c("rr_central", "rr_lower", "rr_upper")]),
      rr_increment = 10, 
      erf_shape = "log_linear",
      first_age_pop = 0,
      last_age_pop = 99,
      prob_natural_death_male = lifetable_withPopulation[["male"]]$death_probability_natural,
      prob_natural_death_female = lifetable_withPopulation[["female"]]$death_probability_natural,
      prob_total_death_male = lifetable_withPopulation[["male"]]$death_probability_total,
      prob_total_death_female = lifetable_withPopulation[["female"]]$death_probability_total,
      population_midyear_male = lifetable_withPopulation[["male"]]$population, 
      population_midyear_female = lifetable_withPopulation[["female"]]$population, 
      year_of_analysis = 2019, 
      info = input_data_mortality$pollutant[2], 
      min_age = if(is.na(input_data_mortality$min_age[2])) NULL else input_data_mortality$min_age[2],
      max_age = 99)
      #max_age = if(is.na(input_data_mortality$max_age[2])) NULL else input_data_mortality$max_age[2])

head(impact_yll_expDistribution_raw$`2019`$`PM2.5_premature deaths_all causes_adults_main_ERS-ISEE_2022_selected`$total$impact)
```


```{r yll lifetable with single relative risk}
impact_yll_expDistribution_1rr <- list()
impact_yll_expDistribution_1rr[[input_data_mortality$year[2]]][[input_data_mortality$rr_id[[2]]]] <-
    bestcost::attribute_yll_lifetable_rr(
      exp = input_data_mortality$exp[2],
      # exp = c(8, 9, 10), # Fake data just for testing purposes
      prop_pop_exp = 1,
      # prop_pop_exp = c(0.2, 0.3, 0.5), # Fake data just for testing purposes
      cutoff = input_data_mortality$cutoff[2], # WHO AQG 2021 
      rr = unlist(input_data_mortality[2, c("rr_central")]),
      rr_increment = 10, 
      erf_shape = "log_linear",
      first_age_pop = 0,
      last_age_pop = 99,
      prob_natural_death_male = lifetable_withPopulation[["male"]]$death_probability_natural,
      prob_natural_death_female = lifetable_withPopulation[["female"]]$death_probability_natural,
      prob_total_death_male = lifetable_withPopulation[["male"]]$death_probability_total,
      prob_total_death_female = lifetable_withPopulation[["female"]]$death_probability_total,
      population_midyear_male = lifetable_withPopulation[["male"]]$population, 
      population_midyear_female = lifetable_withPopulation[["female"]]$population, 
      year_of_analysis = 2019, 
      info = input_data_mortality$pollutant[2], 
      min_age = if(is.na(input_data_mortality$min_age[2])) NULL else input_data_mortality$min_age[2],
      max_age = 99)
      #max_age = if(is.na(input_data_mortality$max_age[2])) NULL else input_data_mortality$max_age[2])

head(impact_yll_expDistribution_raw$`2019`$`PM2.5_premature deaths_all causes_adults_main_ERS-ISEE_2022_selected`$total$impact)
```

```{r morbidity yld lifetable}
yld <- attribute_yld_lifetable_rr(
  exp = input_data_mortality$exp[2],
  # exp = c(8, 9, 10), # Fake data just for testing purposes
  prop_pop_exp = 1,
  # prop_pop_exp = c(0.2, 0.3, 0.5), # Fake data just for testing purposes
  cutoff = input_data_mortality$cutoff[2],
  rr = unlist(input_data_mortality[2, c("rr_central", "rr_lower", "rr_upper")]), # "rr_central", "rr_lower", "rr_upper"
  rr_increment = 10, 
  erf_shape = "log_linear",
  first_age_pop = 0,last_age_pop = 99,
  prob_natural_death_male = lifetable_withPopulation[["male"]]$death_probability_natural,
  prob_natural_death_female = lifetable_withPopulation[["female"]]$death_probability_natural,
  prob_total_death_male = lifetable_withPopulation[["male"]]$death_probability_total,
  prob_total_death_female = lifetable_withPopulation[["female"]]$death_probability_total,
  population_midyear_male = lifetable_withPopulation[["male"]]$population, 
  population_midyear_female = lifetable_withPopulation[["female"]]$population,
  year_of_analysis = 2019, 
  info = input_data_mortality$pollutant[2], 
  # min_age = 20,
  min_age = input_data_mortality$min_age[2],
  # min_age = NA,
  max_age = 99,
  # max_age = input_data_mortality$max_age[2],
  # max_age = NA,
  corrected_discount_rate = 0,
  # duration = 2,
  disability_weight = 1
  )

print(paste("YLD", head(yld$total$impact_rounded)))
print("YLL (not discounted, as comparison) 40541.98 14640.90 27741.97")
```
```{r morbidity yld lifetable with single relative risk}
yld_1rr <- attribute_yld_lifetable_rr(
  exp = input_data_mortality$exp[2],
  # exp = c(8, 9, 10), # Fake data just for testing purposes
  prop_pop_exp = 1,
  # prop_pop_exp = c(0.2, 0.3, 0.5), # Fake data just for testing purposes
  cutoff = input_data_mortality$cutoff[2],
  rr = unlist(input_data_mortality[2, c("rr_central")]), # "rr_central", 
  rr_increment = 10, 
  erf_shape = "log_linear",
  first_age_pop = 0,last_age_pop = 99,
  prob_natural_death_male = lifetable_withPopulation[["male"]]$death_probability_natural,
  prob_natural_death_female = lifetable_withPopulation[["female"]]$death_probability_natural,
  prob_total_death_male = lifetable_withPopulation[["male"]]$death_probability_total,
  prob_total_death_female = lifetable_withPopulation[["female"]]$death_probability_total,
  population_midyear_male = lifetable_withPopulation[["male"]]$population, 
  population_midyear_female = lifetable_withPopulation[["female"]]$population,
  year_of_analysis = 2019, 
  info = input_data_mortality$pollutant[2], 
  # min_age = 20,
  min_age = input_data_mortality$min_age[2],
  # min_age = NA,
  max_age = 99,
  # max_age = input_data_mortality$max_age[2],
  # max_age = NA,
  corrected_discount_rate = 0,
  # duration = 2,
  disability_weight = 1
  )

print(paste("YLD", head(yld$total$impact_rounded)))
print("YLL (not discounted, as comparison) 40541.98 14640.90 27741.97")
```

## Comparison

```{r comparison singlebhd_rr}
# Test delta comparison function with fake values
comparison_delta_singlebhd_rr <-
  bestcost::compare_health_singlebhd_rr(
    comparison_method = "delta",
    exp_1 = 8.85, 
    exp_2 = 6,
    cutoff = 5,    
    bhd_1 = 25000,
    bhd_2 = 25000,
    rr = c(1.118, 1.060, 1.179),
    rr_increment = 10, 
    erf_shape = "log_linear", 
    info_1 = "PM2.5_mortality_2010",
    info_2 = "PM2.5_mortality_2020")


# Test pif comparison function with fake values
comparison_pif_singlebhd_rr <-
  bestcost::compare_health_singlebhd_rr(
    comparison_method = "pif",
    exp_1 = 8.85,  
    exp_2 = 6,
    cutoff = 5,    
    bhd_1 = 25000,
    bhd_2 = 25000,
    rr = c(1.118, 1.060, 1.179),
    rr_increment = 10, 
    erf_shape = "log_linear", 
    info_1 = "PM2.5_mortality_2010",
    info_2 = "PM2.5_mortality_2020")


```


```{r comparison ar}
# Test delta comparison function with fake values
# No PIF option in ar
comparison_delta_singlebhd_ar <-
  bestcost::compare_health_ar(
    exp_1 = c(57.5, 62.5, 67.5, 72.5, 77.5),# Values as example provided by NIPH
    exp_2 = c(50, 55, 60, 65, 75), # Fake values
    pop_exp_1 = c(387500, 286000, 191800, 72200, 7700), # Values as example provided by NIPH
    pop_exp_2 = c(387500, 286000, 191800, 72200, 7700), # Fake values
    erf_c = "78.9270-3.1162*c+0.0342*c^2",
    info_1 = data.frame(pollutant = "road_noise", outcome = "highly_annoyance", year = 2020),
    info_2 = data.frame(pollutant = "road_noise", outcome = "highly_annoyance", year = 2022))




```


```{r comparison deaths lifetable}
 
comparison_deaths_lifetable_delta <-
  bestcost::compare_deaths_lifetable_rr(
    comparison_method = "delta",
    exp_1 = 8.85, # Fake data just for testing purposes
    prop_pop_exp_1 = 1, # Fake data just for testing purposes
    exp_2 = 6, # Fake data just for testing purposes
    prop_pop_exp_2 = 1, # Fake data just for testing purposes
    cutoff = 5,   # PM2.5=5, WHO AQG 2021 
    rr = c(1.118, 1.060, 1.179),
    rr_increment = 10, 
    erf_shape = "log_linear",
    first_age_pop_1 = 0,
    last_age_pop_1 = 99,
    prob_natural_death_male_1 = lifetable_withPopulation[["male"]]$death_probability_natural,
    prob_natural_death_female_1 = lifetable_withPopulation[["female"]]$death_probability_natural,
    prob_total_death_male_1 = lifetable_withPopulation[["male"]]$death_probability_total,
    prob_total_death_female_1 = lifetable_withPopulation[["female"]]$death_probability_total,
    population_midyear_male_1 = lifetable_withPopulation[["male"]]$population, 
    population_midyear_female_1 = lifetable_withPopulation[["female"]]$population, 
    year_of_analysis_1 = 2019, 
    first_age_pop_2 = 0,
    last_age_pop_2 = 99,
    prob_natural_death_male_2 = lifetable_withPopulation[["male"]]$death_probability_natural,
    prob_natural_death_female_2 = lifetable_withPopulation[["female"]]$death_probability_natural,
    prob_total_death_male_2 = lifetable_withPopulation[["male"]]$death_probability_total,
    prob_total_death_female_2 = lifetable_withPopulation[["female"]]$death_probability_total,
    population_midyear_male_2 = lifetable_withPopulation[["male"]]$population, 
    population_midyear_female_2 = lifetable_withPopulation[["female"]]$population, 
     year_of_analysis_2 = 2019,
    info_1 = input_data_mortality$pollutant[i],
    info_2 = input_data_mortality$pollutant[i], 
    min_age = 30,
    max_age = NULL)
    # max_age = if(is.na(input_data_mortality$max_age[i])) NULL else input_data_mortality$max_age[i])

comparison_deaths_lifetable_pif  <-
  bestcost::compare_deaths_lifetable_rr(
    comparison_method = "pif",
    exp_1 = 8.85, # Fake data just for testing purposes
    prop_pop_exp_1 = 1, # Fake data just for testing purposes
    exp_2 = 6, # Fake data just for testing purposes
    prop_pop_exp_2 = 1, # Fake data just for testing purposes
    cutoff = 5,   # PM2.5=5, WHO AQG 2021 
    rr = c(1.118, 1.060, 1.179),
    rr_increment = 10, 
    erf_shape = "log_linear",
    first_age_pop_1 = 0,
    last_age_pop_1 = 99,
    prob_natural_death_male_1 = lifetable_withPopulation[["male"]]$death_probability_natural,
    prob_natural_death_female_1 = lifetable_withPopulation[["female"]]$death_probability_natural,
    prob_total_death_male_1 = lifetable_withPopulation[["male"]]$death_probability_total,
    prob_total_death_female_1 = lifetable_withPopulation[["female"]]$death_probability_total,
    population_midyear_male_1 = lifetable_withPopulation[["male"]]$population, 
    population_midyear_female_1 = lifetable_withPopulation[["female"]]$population, 
    year_of_analysis_1 = 2019, 
    first_age_pop_2 = 0,
    last_age_pop_2 = 99,
    prob_natural_death_male_2 = lifetable_withPopulation[["male"]]$death_probability_natural,
    prob_natural_death_female_2 = lifetable_withPopulation[["female"]]$death_probability_natural,
    prob_total_death_male_2 = lifetable_withPopulation[["male"]]$death_probability_total,
    prob_total_death_female_2 = lifetable_withPopulation[["female"]]$death_probability_total,
    population_midyear_male_2 = lifetable_withPopulation[["male"]]$population, 
    population_midyear_female_2 = lifetable_withPopulation[["female"]]$population, 
    year_of_analysis_2 = 2019, 
    info_1 = NULL,
    info_2 = NULL, 
    min_age = 30,
    max_age = NULL)
```



```{r comparison yll lifetable}
 
comparison_yll_lifetable_delta  <-
  bestcost::compare_yll_lifetable_rr(
    comparison_method = "delta",
    exp_1 = 8.85, # Fake data just for testing purposes
    prop_pop_exp_1 = 1, # Fake data just for testing purposes
    exp_2 = 6, # Fake data just for testing purposes
    prop_pop_exp_2 = 1, # Fake data just for testing purposes
    cutoff = 5,   # PM2.5=5, WHO AQG 2021 
    rr = c(1.118, 1.060, 1.179),
    rr_increment = 10, 
    erf_shape = "log_linear",
    first_age_pop_1 = 0,
    last_age_pop_1 = 99,
    prob_natural_death_male_1 = lifetable_withPopulation[["male"]]$death_probability_natural,
    prob_natural_death_female_1 = lifetable_withPopulation[["female"]]$death_probability_natural,
    prob_total_death_male_1 = lifetable_withPopulation[["male"]]$death_probability_total,
    prob_total_death_female_1 = lifetable_withPopulation[["female"]]$death_probability_total,
    population_midyear_male_1 = lifetable_withPopulation[["male"]]$population, 
    population_midyear_female_1 = lifetable_withPopulation[["female"]]$population, 
    year_of_analysis_1 = 2019, 
    first_age_pop_2 = 0,
    last_age_pop_2 = 99,
    prob_natural_death_male_2 = lifetable_withPopulation[["male"]]$death_probability_natural,
    prob_natural_death_female_2 = lifetable_withPopulation[["female"]]$death_probability_natural,
    prob_total_death_male_2 = lifetable_withPopulation[["male"]]$death_probability_total,
    prob_total_death_female_2 = lifetable_withPopulation[["female"]]$death_probability_total,
    population_midyear_male_2 = lifetable_withPopulation[["male"]]$population, 
    population_midyear_female_2 = lifetable_withPopulation[["female"]]$population, 
    year_of_analysis_2 = 2019, 
    info_1 = input_data_mortality$pollutant[i],
    info_2 = input_data_mortality$pollutant[i], 
    min_age = 30,
    max_age = NULL)
    # max_age = if(is.na(input_data_mortality$max_age[i])) NULL else input_data_mortality$max_age[i])

comparison_yll_lifetable_pif <-
  bestcost::compare_yll_lifetable_rr(
    comparison_method = "pif",
    exp_1 = 8.85, # Fake data just for testing purposes
    prop_pop_exp_1 = 1, # Fake data just for testing purposes
    exp_2 = 6, # Fake data just for testing purposes
    prop_pop_exp_2 = 1, # Fake data just for testing purposes
    cutoff = 5,   # PM2.5=5, WHO AQG 2021 
    rr = c(1.118, 1.060, 1.179),
    rr_increment = 10, 
    erf_shape = "log_linear",
    first_age_pop_1 = 0,
    last_age_pop_1 = 99,
    prob_natural_death_male_1 = lifetable_withPopulation[["male"]]$death_probability_natural,
    prob_natural_death_female_1 = lifetable_withPopulation[["female"]]$death_probability_natural,
    prob_total_death_male_1 = lifetable_withPopulation[["male"]]$death_probability_total,
    prob_total_death_female_1 = lifetable_withPopulation[["female"]]$death_probability_total,
    population_midyear_male_1 = lifetable_withPopulation[["male"]]$population, 
    population_midyear_female_1 = lifetable_withPopulation[["female"]]$population, 
    year_of_analysis_1 = 2019, 
    first_age_pop_2 = 0,
    last_age_pop_2 = 99,
    prob_natural_death_male_2 = lifetable_withPopulation[["male"]]$death_probability_natural,
    prob_natural_death_female_2 = lifetable_withPopulation[["female"]]$death_probability_natural,
    prob_total_death_male_2 = lifetable_withPopulation[["male"]]$death_probability_total,
    prob_total_death_female_2 = lifetable_withPopulation[["female"]]$death_probability_total,
    population_midyear_male_2 = lifetable_withPopulation[["male"]]$population, 
    population_midyear_female_2 = lifetable_withPopulation[["female"]]$population, 
    year_of_analysis_2 = 2019, 
    info_1 = NULL,
    info_2 = NULL, 
    min_age = 30,
    max_age = NULL)
```





```{r comparison yld lifetable}
 
comparison_yld_lifetable_delta  <-
  bestcost::compare_yld_lifetable_rr(
    comparison_method = "delta",
    exp_1 = 8.85, # Fake data just for testing purposes
    prop_pop_exp_1 = 1, # Fake data just for testing purposes
    exp_2 = 6, # Fake data just for testing purposes
    prop_pop_exp_2 = 1, # Fake data just for testing purposes
    cutoff = 5,   # PM2.5=5, WHO AQG 2021 
    rr = c(1.118, 1.060, 1.179),
    rr_increment = 10, 
    erf_shape = "log_linear",
    first_age_pop_1 = 0,
    last_age_pop_1 = 99,
    prob_natural_death_male_1 = lifetable_withPopulation[["male"]]$death_probability_natural,
    prob_natural_death_female_1 = lifetable_withPopulation[["female"]]$death_probability_natural,
    prob_total_death_male_1 = lifetable_withPopulation[["male"]]$death_probability_total,
    prob_total_death_female_1 = lifetable_withPopulation[["female"]]$death_probability_total,
    population_midyear_male_1 = lifetable_withPopulation[["male"]]$population, 
    population_midyear_female_1 = lifetable_withPopulation[["female"]]$population, 
    year_of_analysis_1 = 2019, 
    first_age_pop_2 = 0,
    last_age_pop_2 = 99,
    prob_natural_death_male_2 = lifetable_withPopulation[["male"]]$death_probability_natural,
    prob_natural_death_female_2 = lifetable_withPopulation[["female"]]$death_probability_natural,
    prob_total_death_male_2 = lifetable_withPopulation[["male"]]$death_probability_total,
    prob_total_death_female_2 = lifetable_withPopulation[["female"]]$death_probability_total,
    population_midyear_male_2 = lifetable_withPopulation[["male"]]$population, 
    population_midyear_female_2 = lifetable_withPopulation[["female"]]$population, 
    year_of_analysis_2 = 2019, 
    info_1 = input_data_mortality$pollutant[i],
    info_2 = input_data_mortality$pollutant[i], 
    min_age = 30,
    max_age = NULL,
    disability_weight = 0.5,
    duration = 2)

comparison_yld_lifetable_pif <-
  bestcost::compare_yld_lifetable_rr(
    comparison_method = "pif",
    exp_1 = 8.85, # Fake data just for testing purposes
    prop_pop_exp_1 = 1, # Fake data just for testing purposes
    exp_2 = 6, # Fake data just for testing purposes
    prop_pop_exp_2 = 1, # Fake data just for testing purposes
    cutoff = 5,   # PM2.5=5, WHO AQG 2021 
    rr = c(1.118, 1.060, 1.179),
    rr_increment = 10, 
    erf_shape = "log_linear",
    first_age_pop_1 = 0,
    last_age_pop_1 = 99,
    prob_natural_death_male_1 = lifetable_withPopulation[["male"]]$death_probability_natural,
    prob_natural_death_female_1 = lifetable_withPopulation[["female"]]$death_probability_natural,
    prob_total_death_male_1 = lifetable_withPopulation[["male"]]$death_probability_total,
    prob_total_death_female_1 = lifetable_withPopulation[["female"]]$death_probability_total,
    population_midyear_male_1 = lifetable_withPopulation[["male"]]$population, 
    population_midyear_female_1 = lifetable_withPopulation[["female"]]$population, 
    year_of_analysis_1 = 2019, 
    first_age_pop_2 = 0,
    last_age_pop_2 = 99,
    prob_natural_death_male_2 = lifetable_withPopulation[["male"]]$death_probability_natural,
    prob_natural_death_female_2 = lifetable_withPopulation[["female"]]$death_probability_natural,
    prob_total_death_male_2 = lifetable_withPopulation[["male"]]$death_probability_total,
    prob_total_death_female_2 = lifetable_withPopulation[["female"]]$death_probability_total,
    population_midyear_male_2 = lifetable_withPopulation[["male"]]$population, 
    population_midyear_female_2 = lifetable_withPopulation[["female"]]$population, 
    year_of_analysis_2 = 2019, 
    info_1 = NULL,
    info_2 = NULL, 
    min_age = 30,
    max_age = NULL,
    disability_weight = 0.5,
    duration = 2)
```


```{r comparison yld singlebhd_rr}
# Test delta comparison function with fake values
comparison_yld_singlebhd_rr_delta <-
  bestcost::compare_yld_singlebhd_rr(
    comparison_method = "delta",
    exp_1 = 8.85, 
    exp_2 = 6,
    cutoff = 5,    
    bhd_1 = 25000,
    bhd_2 = 25000,
    rr = c(1.118, 1.060, 1.179),
    rr_increment = 10, 
    erf_shape = "log_linear", 
    disability_weight = 0.5,
    info_1 = "PM2.5_yld_before",
    info_2 = "PM2.5_yld_after")


# Test pif comparison function with fake values
comparison_yld_singlebhd_rr_pif <-
  bestcost::compare_yld_singlebhd_rr(
    comparison_method = "pif",
    exp_1 = 8.85,  
    exp_2 = 6,
    cutoff = 5,    
    bhd_1 = 25000,
    bhd_2 = 25000,
    rr = c(1.118, 1.060, 1.179),
    rr_increment = 10, 
    erf_shape = "log_linear", 
    disability_weight = 0.5,
    info_1 = "PM2.5_yld_before",
    info_2 = "PM2.5_yld_after")


```

# Export 

```{r eval=FALSE, include=FALSE}
write.csv2(lifetable_airqplus,
            "../testing/output/lifetable_airqplus_2019_ch.csv", 
            row.names = FALSE)
```
